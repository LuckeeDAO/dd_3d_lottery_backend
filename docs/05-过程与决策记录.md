# DD 3D 彩票智能合约 过程与决策记录

## 📋 文档信息

- **项目名称**: DD 3D Lottery (3D彩票智能合约)
- **版本**: v1.0
- **文档类型**: 过程与决策记录
- **创建日期**: 2024-01-XX
- **最后更新**: 2024-01-XX

## 🎯 概述

本文档记录了DD 3D Lottery项目开发过程中的重要决策、技术选择、问题解决和变更历史，为后续开发和维护提供参考。

## 📊 决策记录模板

### ADR-001: 技术栈选择

**状态**: 已接受  
**日期**: 2024-01-XX  
**决策者**: 开发团队  

#### 背景
需要为3D彩票智能合约选择合适的技术栈，确保安全性、性能和可维护性。

#### 决策
选择CosmWasm 2.2.2 + Rust作为主要技术栈。

#### 理由
1. **安全性**: CosmWasm提供沙盒环境，防止恶意代码执行
2. **性能**: Rust提供零成本抽象和内存安全
3. **生态**: CosmWasm有成熟的工具链和社区支持
4. **兼容性**: 与现有区块链基础设施兼容

#### 后果
- **正面**: 高安全性、高性能、丰富的工具支持
- **负面**: 学习曲线较陡峭、开发周期可能较长
- **风险**: 技术栈相对较新，可能存在未知问题

#### 替代方案
- **Solidity + EVM**: 生态成熟但安全性相对较低
- **Move + Aptos**: 新兴技术，生态不够成熟
- **原生Cosmos SDK**: 开发复杂度高，不适合智能合约

---

### ADR-003: 禁止使用外部加密库

**状态**: 已接受  
**日期**: 2024-12-19  
**决策者**: 安全团队 + 开发团队  

#### 背景
在代码审查过程中发现项目依赖了 `ed25519-zebra = "4.0.3"` 外部加密库，但实际代码中并未使用该库。需要制定外部加密库使用规范。

#### 决策
**禁止使用任何外部加密库**，包括但不限于：
- `ed25519-zebra`
- `ed25519-dalek` 
- `secp256k1`
- `ring`
- `openssl`
- `rustls`

#### 理由

1. **安全风险**：
   - 外部加密库可能包含未审计的代码
   - 增加依赖链攻击面
   - 难以确保所有依赖的安全性

2. **版本控制风险**：
   - 外部库版本更新可能引入破坏性变更
   - 难以控制依赖的更新时机
   - 可能引入新的安全漏洞

3. **审计复杂性**：
   - 智能合约需要完全可审计
   - 外部依赖增加了审计复杂度
   - 难以确保所有依赖都是安全的

4. **CosmWasm 生态最佳实践**：
   - CosmWasm 已经提供了所有必要的加密功能
   - 官方库经过充分测试和审计
   - 与 CosmWasm 运行时完全兼容

#### 后果

- **正面**: 
  - 减少安全风险
  - 简化依赖管理
  - 提高代码可审计性
  - 符合 CosmWasm 最佳实践

- **负面**: 
  - 限制了某些高级加密功能的直接使用
  - 需要学习 CosmWasm 内置加密 API

- **风险**: 
  - 无重大风险，CosmWasm 内置功能已足够

#### 替代方案

**推荐使用 CosmWasm 内置功能**：

```rust
// ✅ 推荐：使用 CosmWasm 内置功能
use cosmwasm_std::{
    Addr, 
    CanonicalAddr,
    // 内置的地址验证和加密功能
};

// ✅ 推荐：使用 CosmWasm 官方加密库
use cosmwasm_crypto::*;

// ❌ 禁止：使用外部加密库
use ed25519_zebra::*;
use secp256k1::*;
```

#### 实施措施

1. **立即行动**：
   - 从 `Cargo.toml` 中移除 `ed25519-zebra` 依赖
   - 更新架构约束文档

2. **长期措施**：
   - 在 CI/CD 中添加依赖检查
   - 定期审查项目依赖
   - 建立依赖管理规范

#### 相关文档
- [架构与设计约束](03-架构与设计约束.md)
- [CosmWasm 官方文档](https://docs.cosmwasm.com/)

---

### ADR-004: 三阶段投注系统设计

**状态**: 已接受  
**日期**: 2024-01-XX  
**决策者**: 开发团队  

#### 背景
需要设计一个公平、透明的投注系统，防止提前泄露和操控。

#### 决策
采用基于区块链高度的三阶段投注系统：
- **承诺阶段 (0-5999)**: 用户提交承诺哈希
- **中奖揭秘阶段 (6000-8999)**: 用户揭秘随机数
- **结算阶段 (9000-9999)**: 系统计算中奖号码

#### 理由
1. **公平性**: 承诺-揭秘机制防止提前泄露
2. **透明性**: 基于区块链高度，完全可预测
3. **安全性**: 多阶段验证，防止单点攻击
4. **用户体验**: 清晰的阶段划分，用户易于理解

#### 后果
- **正面**: 高度公平透明、安全性强
- **负面**: 用户需要等待特定阶段才能操作
- **风险**: 阶段切换可能影响用户体验

#### 替代方案
- **单阶段投注**: 简单但安全性较低
- **多轮投注**: 复杂度过高，用户体验差
- **时间驱动**: 依赖外部时间源，不够去中心化

---

### ADR-003: 随机数生成机制

**状态**: 已接受  
**日期**: 2024-01-XX  
**决策者**: 开发团队  

#### 背景
需要设计一个安全、不可预测的随机数生成机制。

#### 决策
采用基于dd_algorithms_lib的去中心化随机数生成机制：
1. 用户提供随机数种子
2. 使用dd_algorithms_lib的get_one_dd_3d_rand_num函数
3. 结合所有参与者的随机数生成最终中奖号码
4. 确保去中心化和公平性

#### 理由
1. **去中心化**: 使用专门的去中心化算法库
2. **公平性**: 所有参与者都参与随机数生成
3. **透明性**: 生成过程完全公开可验证
4. **安全性**: 使用成熟的去中心化算法
5. **专业性**: 专门为去中心化场景设计的算法

#### 后果
- **正面**: 高度安全、完全透明
- **负面**: 依赖用户提供随机数质量
- **风险**: 用户可能提供弱随机数

#### 替代方案
- **区块链随机数**: 可能被矿工操控
- **外部随机数源**: 不够去中心化
- **纯用户随机数**: 安全性不够
- **SHA256哈希**: 不是专门的去中心化算法

---

### ADR-004: 奖金分配策略

**状态**: 已接受  
**日期**: 2024-01-XX  
**决策者**: 开发团队  

#### 决策
采用固定奖金 + 奖金池平分的混合策略：
- 每名中奖者固定获得800元
- 或平分当期奖金池（取较小值）
- 90%销售额作为奖金池
- 10%作为软件服务费

#### 理由
1. **公平性**: 中奖者获得合理奖励
2. **可持续性**: 服务费保证系统运营
3. **激励性**: 固定奖金提供明确预期
4. **灵活性**: 奖金池机制适应不同规模

#### 后果
- **正面**: 平衡公平性和可持续性
- **负面**: 小规模投注时奖金可能较低
- **风险**: 服务费率需要合理设置

#### 替代方案
- **纯固定奖金**: 可能无法覆盖成本
- **纯奖金池平分**: 小规模时奖金过低
- **阶梯式奖金**: 复杂度高，用户体验差

---

### ADR-005: 存储架构设计

**状态**: 已接受  
**日期**: 2024-01-XX  
**决策者**: 开发团队  

#### 背景
需要设计高效的存储架构，支持大量用户和交易。

#### 决策
采用cw-storage-plus的Map和Item结构：
- `CURRENT_SESSION`: 当前彩票会话
- `COMMITMENTS`: 参与者承诺映射
- `LOTTERY_HISTORY`: 历史结果映射
- `CONFIG`: 系统配置
- `STATS`: 统计信息

#### 理由
1. **性能**: Map提供O(1)查询性能
2. **灵活性**: 支持动态数据存储
3. **可扩展性**: 易于添加新的存储项
4. **Gas效率**: 优化的存储操作

#### 后果
- **正面**: 高性能、易扩展
- **负面**: 存储成本相对较高
- **风险**: 大量数据可能影响性能

#### 替代方案
- **原生存储**: 性能较低，开发复杂
- **外部存储**: 不够去中心化
- **压缩存储**: 可能影响查询性能

---

### ADR-006: 错误处理策略

**状态**: 已接受  
**日期**: 2024-01-XX  
**决策者**: 开发团队  

#### 背景
需要设计统一的错误处理机制，提供清晰的错误信息。

#### 决策
采用thiserror库定义结构化错误类型：
- 使用枚举定义所有错误类型
- 提供详细的错误消息
- 包含错误上下文信息
- 支持错误链追踪

#### 理由
1. **一致性**: 统一的错误处理方式
2. **可维护性**: 易于添加和修改错误类型
3. **调试性**: 详细的错误信息便于调试
4. **用户体验**: 清晰的错误提示

#### 后果
- **正面**: 错误处理统一、信息详细
- **负面**: 错误类型较多，维护复杂
- **风险**: 错误信息可能泄露敏感信息

#### 替代方案
- **简单字符串错误**: 信息不够详细
- **数字错误码**: 用户体验差
- **外部错误服务**: 不够去中心化

---

## 🔄 变更记录

### 变更记录模板

| 变更ID | 日期 | 变更类型 | 变更内容 | 影响范围 | 变更人 |
|--------|------|----------|----------|----------|--------|
| CHG-001 | 2024-01-XX | 需求变更 | 调整最小投注金额 | 配置系统 | 开发团队 |
| CHG-002 | 2024-01-XX | 技术变更 | 优化Gas消耗 | 所有操作 | 开发团队 |
| CHG-003 | 2024-01-XX | 功能变更 | 增加统计查询 | 查询接口 | 开发团队 |

### 详细变更记录

#### CHG-001: 调整最小投注金额

**变更日期**: 2024-01-XX  
**变更类型**: 需求变更  
**变更内容**: 将最小投注金额从500调整为1000  
**变更原因**: 提高投注门槛，减少小额投注的Gas消耗  
**影响范围**: 配置系统、投注验证  
**风险评估**: 低风险，向后兼容  
**实施计划**: 通过配置更新实现，无需代码修改  

#### CHG-002: 优化Gas消耗

**变更日期**: 2024-01-XX  
**变更类型**: 技术变更  
**变更内容**: 优化存储操作，减少Gas消耗  
**变更原因**: 提高系统性能，降低用户成本  
**影响范围**: 所有存储操作  
**风险评估**: 中等风险，需要充分测试  
**实施计划**: 分阶段实施，先测试后部署  

#### CHG-003: 增加统计查询

**变更日期**: 2024-01-XX  
**变更类型**: 功能变更  
**变更内容**: 新增系统统计信息查询接口  
**变更原因**: 提供更好的系统监控和分析能力  
**影响范围**: 查询接口、存储结构  
**风险评估**: 低风险，纯新增功能  
**实施计划**: 直接添加新接口，不影响现有功能  

---

## 🚨 问题解决记录

### 问题记录模板

| 问题ID | 日期 | 问题类型 | 问题描述 | 解决方案 | 状态 |
|--------|------|----------|----------|----------|------|
| ISS-001 | 2024-01-XX | 性能问题 | Gas消耗过高 | 优化存储操作 | 已解决 |
| ISS-002 | 2024-01-XX | 安全问题 | 重入攻击风险 | 添加重入锁 | 已解决 |
| ISS-003 | 2024-01-XX | 功能问题 | 阶段判断错误 | 修复算法逻辑 | 已解决 |

### 详细问题记录

#### ISS-001: Gas消耗过高

**问题日期**: 2024-01-XX  
**问题类型**: 性能问题  
**问题描述**: 投注操作的Gas消耗超过50000，影响用户体验  
**问题原因**: 存储操作过多，数据结构不够优化  
**解决方案**: 
1. 合并多个存储操作为单个操作
2. 优化数据结构，减少存储空间
3. 使用批量操作减少交易数量
**解决状态**: 已解决  
**验证结果**: Gas消耗降低到40000以下  

#### ISS-002: 重入攻击风险

**问题日期**: 2024-01-XX  
**问题类型**: 安全问题  
**问题描述**: 发现潜在的重入攻击风险  
**问题原因**: 缺少重入保护机制  
**解决方案**: 
1. 添加重入锁机制
2. 使用检查-效果-交互模式
3. 限制外部调用
**解决状态**: 已解决  
**验证结果**: 通过安全审计，无重入风险  

#### ISS-003: 阶段判断错误

**问题日期**: 2024-01-XX  
**问题类型**: 功能问题  
**问题描述**: 阶段判断算法存在边界条件错误  
**问题原因**: 模数计算边界处理不当  
**解决方案**: 
1. 修复边界条件判断
2. 添加边界测试用例
3. 完善错误处理
**解决状态**: 已解决  
**验证结果**: 所有边界条件测试通过  

---

## 🔒 安全决策总结

### 关键安全决策

| 决策ID | 决策内容 | 重要性 | 影响范围 | 实施状态 |
|--------|----------|--------|----------|----------|
| ADR-003 | 禁止使用外部加密库 | 🔴 高 | 全项目 | ✅ 已实施 |
| ADR-001 | 选择CosmWasm技术栈 | 🔴 高 | 全项目 | ✅ 已实施 |
| ADR-002 | 三阶段投注系统 | 🟡 中 | 核心功能 | ✅ 已实施 |

### 安全最佳实践

1. **依赖管理**：
   - ✅ 只使用CosmWasm官方库
   - ✅ 定期审查项目依赖
   - ✅ 避免引入外部加密库

2. **代码审计**：
   - ✅ 所有代码必须可审计
   - ✅ 避免使用unsafe代码
   - ✅ 遵循CosmWasm最佳实践

3. **安全测试**：
   - ✅ 包含重入攻击测试
   - ✅ 包含边界条件测试
   - ✅ 包含权限控制测试

### 后续项目参考

**重要提醒**：对于所有基于CosmWasm的智能合约项目，请务必遵循以下安全原则：

1. **禁止使用外部加密库**：
   - 不要添加 `ed25519-zebra`、`secp256k1`、`ring` 等外部加密库
   - 使用CosmWasm内置的加密功能
   - 定期检查 `Cargo.toml` 中的依赖

2. **依赖审查流程**：
   - 每次添加新依赖前进行安全评估
   - 优先使用CosmWasm官方推荐的库
   - 建立依赖白名单机制

3. **代码审计要求**：
   - 确保所有代码都是可审计的
   - 避免使用复杂的第三方依赖
   - 保持代码简洁和可理解

---

## 📈 性能优化记录

### 优化记录模板

| 优化ID | 日期 | 优化类型 | 优化内容 | 性能提升 | 影响范围 |
|--------|------|----------|----------|----------|----------|
| OPT-001 | 2024-01-XX | 算法优化 | 优化奖金分配算法 | 30% | 结算操作 |
| OPT-002 | 2024-01-XX | 存储优化 | 压缩数据结构 | 20% | 存储使用 |
| OPT-003 | 2024-01-XX | 查询优化 | 添加索引机制 | 50% | 查询操作 |

### 详细优化记录

#### OPT-001: 优化奖金分配算法

**优化日期**: 2024-01-XX  
**优化类型**: 算法优化  
**优化内容**: 重构奖金分配算法，减少循环次数  
**优化前**: 时间复杂度O(n²)  
**优化后**: 时间复杂度O(n)  
**性能提升**: 30%  
**影响范围**: 结算操作  
**实施方法**: 使用哈希表预计算，避免重复计算  

#### OPT-002: 压缩数据结构

**优化日期**: 2024-01-XX  
**优化类型**: 存储优化  
**优化内容**: 压缩参与者数据结构，减少存储空间  
**优化前**: 每个参与者1KB  
**优化后**: 每个参与者500字节  
**性能提升**: 20%  
**影响范围**: 存储使用  
**实施方法**: 使用位字段和压缩编码  

#### OPT-003: 添加索引机制

**优化日期**: 2024-01-XX  
**优化类型**: 查询优化  
**优化内容**: 为常用查询添加索引  
**优化前**: 查询时间1秒  
**优化后**: 查询时间0.5秒  
**性能提升**: 50%  
**影响范围**: 查询操作  
**实施方法**: 使用Map结构建立索引  

---

## 🔍 技术债务记录

### 技术债务模板

| 债务ID | 日期 | 债务类型 | 债务描述 | 优先级 | 计划解决时间 |
|--------|------|----------|----------|--------|-------------|
| TD-001 | 2024-01-XX | 代码质量 | 部分函数过长 | 中 | 下个版本 |
| TD-002 | 2024-01-XX | 测试覆盖 | 边界条件测试不足 | 高 | 本周 |
| TD-003 | 2024-01-XX | 文档更新 | API文档滞后 | 低 | 下个月 |

### 详细技术债务记录

#### TD-001: 部分函数过长

**债务日期**: 2024-01-XX  
**债务类型**: 代码质量  
**债务描述**: settle_lottery函数超过100行，需要重构  
**影响**: 可读性差，维护困难  
**优先级**: 中  
**计划解决时间**: 下个版本  
**解决方案**: 拆分为多个小函数  

#### TD-002: 边界条件测试不足

**债务日期**: 2024-01-XX  
**债务类型**: 测试覆盖  
**债务描述**: 缺少边界条件和异常情况的测试  
**影响**: 潜在bug风险  
**优先级**: 高  
**计划解决时间**: 本周  
**解决方案**: 添加全面的边界测试用例  

#### TD-003: API文档滞后

**债务日期**: 2024-01-XX  
**债务类型**: 文档更新  
**债务描述**: API文档与代码实现不同步  
**影响**: 开发者体验差  
**优先级**: 低  
**计划解决时间**: 下个月  
**解决方案**: 建立文档更新流程  

---

## 📝 经验教训

### 成功经验

1. **模块化设计**: 将功能拆分为独立模块，提高了代码的可维护性
2. **测试驱动开发**: 先写测试再写代码，减少了bug数量
3. **文档先行**: 完善的文档设计，减少了开发过程中的沟通成本
4. **安全优先**: 从一开始就考虑安全问题，避免了后期的大幅修改

### 失败教训

1. **性能考虑不足**: 初期没有充分考虑性能问题，导致后期需要大量优化
2. **用户体验设计**: 过于关注技术实现，忽略了用户体验
3. **变更管理**: 缺乏有效的变更管理流程，导致一些变更没有充分评估
4. **技术债务积累**: 为了快速交付，积累了一些技术债务

### 改进建议

1. **建立性能基准**: 在开发初期就建立性能基准和监控
2. **用户反馈机制**: 建立用户反馈收集和处理机制
3. **变更控制流程**: 建立严格的变更控制流程
4. **技术债务管理**: 定期评估和解决技术债务

---

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2024-01-XX | 初始过程与决策记录文档创建 | AI Assistant |

---

**注意**: 本文档记录了DD 3D彩票智能合约项目的重要决策和过程，应该定期更新和维护，为项目提供历史参考和决策依据。
