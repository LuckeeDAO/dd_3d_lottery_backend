# DD 3D 彩票智能合约 精确接口契约

## 📋 文档信息

- **项目名称**: DD 3D Lottery (3D彩票智能合约)
- **版本**: v0.1.0
- **文档类型**: 精确接口契约
- **标准**: OpenAPI Specification 3.0
- **创建日期**: 2024-01-XX
- **最后更新**: 2024-01-XX

## 🎯 概述

本文档定义了DD 3D Lottery合约的所有接口，包括请求/响应格式、状态码、错误类型和数据验证规则。作为AI之间、系统与系统之间交互的"法律文书"，确保无缝集成。

## 📡 合约接口规范

### 1. 实例化接口 (InstantiateMsg)

```yaml
openapi: 3.0.0
info:
  title: DD 3D Lottery Contract API
  version: 1.0.0
  description: DD 3D彩票智能合约接口规范

paths:
  /instantiate:
    post:
      summary: 实例化合约
      description: 创建新的DD 3D彩票合约实例
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InstantiateMsg'
      responses:
        '200':
          description: 实例化成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstantiateResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    InstantiateMsg:
      type: object
      required:
        - admin
        - service_fee_rate
        - min_bet_amount
        - max_bet_amount
        - bet_denom
      properties:
        admin:
          type: string
          pattern: '^cosmwasm[a-z0-9]{38}$'
          description: 管理员地址
          example: "cosmwasm1abc123..."
        service_fee_rate:
          type: string
          pattern: '^0\.[0-9]+$'
          description: 服务费率 (0.1 = 10%)
          example: "0.1"
        min_bet_amount:
          type: string
          pattern: '^[0-9]+$'
          minimum: "1000"
          description: 最小投注金额
          example: "1000"
        max_bet_amount:
          type: string
          pattern: '^[0-9]+$'
          minimum: "1000000"
          description: 最大投注金额
          example: "1000000"
        bet_denom:
          type: string
          minLength: 1
          description: 投注代币类型
          example: "uusd"
        pause_requested:
          type: boolean
          description: 是否请求暂停（完成当前周期后暂停）
          default: false

    InstantiateResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        contract_address:
          type: string
          pattern: '^cosmwasm[a-z0-9]{38}$'
          example: "cosmwasm1jkl012..."
        config:
          $ref: '#/components/schemas/ContractConfig'
```

### 2. 执行接口 (ExecuteMsg)

```yaml
  /execute:
    post:
      summary: 执行合约操作
      description: 执行3D彩票相关操作
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteMsg'
      responses:
        '200':
          description: 执行成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    ExecuteMsg:
      type: object
      oneOf:
        - $ref: '#/components/schemas/PlaceBetMsg'
        - $ref: '#/components/schemas/RevealRandomMsg'
        - $ref: '#/components/schemas/SettleLotteryMsg'
        - $ref: '#/components/schemas/AdminMsg'

    PlaceBetMsg:
      type: object
      required:
        - commitment_hash
      properties:
        commitment_hash:
          type: string
          pattern: '^[a-f0-9]{64}$'
          description: 承诺哈希 (SHA256)
          example: "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"

    RevealRandomMsg:
      type: object
      required:
        - lucky_numbers
        - random_seed
      properties:
        lucky_numbers:
          type: array
          items:
            type: integer
            minimum: 0
            maximum: 999
          minItems: 1
          maxItems: 1000000
          description: 投注码列表 (每个投注码对应一个幸运数字0-999，投注码总数必须等于投注金额K)
          example: [123, 123, 456, 456]
        random_seed:
          type: string
          minLength: 1
          maxLength: 100
          description: 用户随机种子
          example: "user_random_string_12345"

    SettleLotteryMsg:
      type: object
      description: 结算彩票

    UpdateConfigMsg:
      type: object
      properties:
        service_fee_rate:
          type: string
          pattern: '^0\.[0-9]+$'
          description: 服务费率
        min_bet_amount:
          type: string
          pattern: '^[0-9]+$'
          description: 最小投注金额
        max_bet_amount:
          type: string
          pattern: '^[0-9]+$'
          description: 最大投注金额
        bet_denom:
          type: string
          description: 投注代币类型
        pause_requested:
          type: boolean
          description: 是否请求暂停

    EmergencyPauseMsg:
      type: object
      required:
        - paused
      properties:
        paused:
          type: boolean
          description: 是否暂停

    WithdrawServiceFeeMsg:
      type: object
      required:
        - amount
      properties:
        amount:
          type: string
          pattern: '^[0-9]+$'
          minimum: "1"
          description: 提取的服务费数量

    ExecuteResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        transaction_hash:
          type: string
          description: 交易哈希
          example: "0x1234567890abcdef..."
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
          description: 事件列表
```

### 3. 查询接口 (QueryMsg)

```yaml
  /query:
    post:
      summary: 查询合约状态
      description: 查询3D彩票相关信息
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryMsg'
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/CurrentSessionResponse'
                  - $ref: '#/components/schemas/ParticipantResponse'
                  - $ref: '#/components/schemas/LotteryResultResponse'
                  - $ref: '#/components/schemas/PhaseResponse'
                  - $ref: '#/components/schemas/ConfigResponse'
                  - $ref: '#/components/schemas/LotteryHistoryResponse'
                  - $ref: '#/components/schemas/ParticipantsResponse'
                  - $ref: '#/components/schemas/StatsResponse'
                  - $ref: '#/components/schemas/VersionResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    QueryMsg:
      type: object
      oneOf:
        - $ref: '#/components/schemas/CurrentSessionQuery'
        - $ref: '#/components/schemas/ParticipantInfoQuery'
        - $ref: '#/components/schemas/LotteryResultQuery'
        - $ref: '#/components/schemas/PhaseQuery'
        - $ref: '#/components/schemas/ConfigQuery'
        - $ref: '#/components/schemas/LotteryHistoryQuery'
        - $ref: '#/components/schemas/ParticipantsQuery'
        - $ref: '#/components/schemas/StatsQuery'
        - $ref: '#/components/schemas/VersionQuery'

    CurrentSessionQuery:
      type: object
      required:
        - get_current_session
      properties:
        get_current_session:
          type: object
          description: 查询当前彩票会话

    ParticipantInfoQuery:
      type: object
      required:
        - get_participant_info
      properties:
        get_participant_info:
          type: object
          required:
            - participant
          properties:
            participant:
              type: string
              pattern: '^cosmwasm[a-z0-9]{38}$'
              description: 参与者地址

    LotteryResultQuery:
      type: object
      required:
        - get_lottery_result
      properties:
        get_lottery_result:
          type: object
          required:
            - session_id
          properties:
            session_id:
              type: string
              description: 彩票会话ID

    PhaseQuery:
      type: object
      required:
        - get_current_phase
      properties:
        get_current_phase:
          type: object
          description: 查询当前阶段

    ConfigQuery:
      type: object
      required:
        - get_config
      properties:
        get_config:
          type: object
          description: 查询合约配置

    LotteryHistoryQuery:
      type: object
      required:
        - get_lottery_history
      properties:
        get_lottery_history:
          type: object
          properties:
            limit:
              type: integer
              minimum: 1
              maximum: 100
              description: 返回数量限制
              default: 10
            start_after:
              type: string
              description: 起始会话ID

    ParticipantsQuery:
      type: object
      required:
        - get_participants
      properties:
        get_participants:
          type: object
          description: 查询参与者列表

    StatsQuery:
      type: object
      required:
        - get_stats
      properties:
        get_stats:
          type: object
          description: 查询统计信息

    VersionQuery:
      type: object
      required:
        - get_version
      properties:
        get_version:
          type: object
          description: 查询合约版本

    CurrentSessionResponse:
      type: object
      properties:
        session:
          $ref: '#/components/schemas/LotterySession'
        phase:
          $ref: '#/components/schemas/LotteryPhase'
        block_height:
          type: integer
          description: 当前区块高度

    LotterySession:
      type: object
      properties:
        session_id:
          type: string
          description: 会话ID
        phase:
          $ref: '#/components/schemas/LotteryPhase'
        total_pool:
          type: string
          pattern: '^[0-9]+$'
          description: 总奖金池
        service_fee:
          type: string
          pattern: '^[0-9]+$'
          description: 服务费
        participants:
          type: array
          items:
            $ref: '#/components/schemas/Participant'
          description: 参与者列表
        created_height:
          type: integer
          description: 创建区块高度
        winning_number:
          type: integer
          minimum: 0
          maximum: 999
          description: 中奖号码
          nullable: true
        settled:
          type: boolean
          description: 是否已结算

    LotteryPhase:
      type: string
      enum: ["Commitment", "Reveal", "Settlement"]
      description: 彩票阶段

    Participant:
      type: object
      properties:
        address:
          type: string
          pattern: '^cosmwasm[a-z0-9]{38}$'
          description: 参与者地址
        bet_amount:
          type: string
          pattern: '^[0-9]+$'
          description: 投注金额
        bet_number:
          type: integer
          minimum: 0
          maximum: 999
          description: 投注数字
        bet_multiplier:
          type: integer
          minimum: 1
          maximum: 1000
          description: 投注倍数
        random_seed:
          type: string
          description: 随机种子
          nullable: true
        revealed:
          type: boolean
          description: 是否已揭秘
        commitment_hash:
          type: string
          description: 承诺哈希
          nullable: true

    ParticipantResponse:
      type: object
      properties:
        participant:
          $ref: '#/components/schemas/Participant'
          nullable: true

    LotteryResultResponse:
      type: object
      properties:
        result:
          $ref: '#/components/schemas/LotteryResult'
          nullable: true

    LotteryResult:
      type: object
      properties:
        session_id:
          type: string
          description: 会话ID
        winning_number:
          type: integer
          minimum: 0
          maximum: 999
          description: 中奖号码
        winners:
          type: array
          items:
            $ref: '#/components/schemas/Winner'
          description: 中奖者列表
        total_rewards:
          type: string
          pattern: '^[0-9]+$'
          description: 总奖金
        settled_height:
          type: integer
          description: 结算区块高度

    Winner:
      type: object
      properties:
        address:
          type: string
          pattern: '^cosmwasm[a-z0-9]{38}$'
          description: 中奖者地址
        reward_amount:
          type: string
          pattern: '^[0-9]+$'
          description: 奖金金额
        bet_number:
          type: integer
          minimum: 0
          maximum: 999
          description: 中奖数字

    PhaseResponse:
      type: object
      properties:
        phase:
          $ref: '#/components/schemas/LotteryPhase'
        block_height:
          type: integer
          description: 当前区块高度
        phase_mod:
          type: integer
          description: 阶段模数

    ConfigResponse:
      type: object
      properties:
        config:
          $ref: '#/components/schemas/ContractConfig'

    ContractConfig:
      type: object
      properties:
        admin:
          type: string
          pattern: '^cosmwasm[a-z0-9]{38}$'
          description: 管理员地址
        service_fee_rate:
          type: string
          pattern: '^0\.[0-9]+$'
          description: 服务费率
        min_bet_amount:
          type: string
          pattern: '^[0-9]+$'
          description: 最小投注金额
        max_bet_amount:
          type: string
          pattern: '^[0-9]+$'
          description: 最大投注金额
        bet_denom:
          type: string
          description: 投注代币类型
        paused:
          type: boolean
          description: 是否暂停
        pause_requested:
          type: boolean
          description: 是否请求暂停（完成当前周期后暂停）

    LotteryHistoryResponse:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/LotteryResult'
          description: 历史结果列表
        total:
          type: integer
          description: 总数量

    ParticipantsResponse:
      type: object
      properties:
        participants:
          type: array
          items:
            $ref: '#/components/schemas/Participant'
          description: 参与者列表
        total:
          type: integer
          description: 总数量

    StatsResponse:
      type: object
      properties:
        total_sessions:
          type: integer
          description: 总会话数
        total_participants:
          type: integer
          description: 总参与者数
        total_pool:
          type: string
          pattern: '^[0-9]+$'
          description: 总奖金池
        total_service_fee:
          type: string
          pattern: '^[0-9]+$'
          description: 总服务费
        total_rewards:
          type: string
          pattern: '^[0-9]+$'
          description: 总奖金

    VersionResponse:
      type: object
      properties:
        contract_name:
          type: string
          description: 合约名称
        contract_version:
          type: string
          description: 合约版本
```

### 4. 错误响应规范

```yaml
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: 错误代码
              example: "INVALID_PHASE"
            message:
              type: string
              description: 错误消息
              example: "当前阶段不允许此操作"
            details:
              type: object
              description: 错误详情
              properties:
                field:
                  type: string
                  description: 错误字段
                  example: "phase"
                value:
                  type: string
                  description: 错误值
                  example: "Commitment"
                suggestion:
                  type: string
                  description: 修复建议
                  example: "请在正确的阶段执行操作"

    ErrorCodes:
      type: object
      properties:
        INVALID_PHASE:
          type: object
          properties:
            code: "INVALID_PHASE"
            message: "当前阶段不允许此操作"
            http_status: 400
        INVALID_COMMITMENT:
          type: object
          properties:
            code: "INVALID_COMMITMENT"
            message: "无效的承诺哈希"
            http_status: 400
        INVALID_BETTING_PARAMS:
          type: object
          properties:
            code: "INVALID_BETTING_PARAMS"
            message: "无效的投注参数"
            http_status: 400
        ALREADY_BET:
          type: object
          properties:
            code: "ALREADY_BET"
            message: "用户已投注"
            http_status: 400
        NOT_REVEALED:
          type: object
          properties:
            code: "NOT_REVEALED"
            message: "用户未揭秘"
            http_status: 400
        UNAUTHORIZED:
          type: object
          properties:
            code: "UNAUTHORIZED"
            message: "调用者无权限执行此操作"
            http_status: 401
        INSUFFICIENT_FUNDS:
          type: object
          properties:
            code: "INSUFFICIENT_FUNDS"
            message: "资金不足"
            http_status: 400
        INVALID_BET_AMOUNT:
          type: object
          properties:
            code: "INVALID_BET_AMOUNT"
            message: "投注金额超出范围"
            http_status: 400
        SYSTEM_PAUSED:
          type: object
          properties:
            code: "SYSTEM_PAUSED"
            message: "系统已暂停"
            http_status: 503
        REENTRANCY_DETECTED:
          type: object
          properties:
            code: "REENTRANCY_DETECTED"
            message: "检测到重入攻击"
            http_status: 400
```

## 🔒 数据验证规则

### 1. 地址验证

```yaml
address_validation:
  pattern: '^cosmwasm[a-z0-9]{38}$'
  description: "CosmWasm地址格式验证"
  examples:
    valid: "cosmwasm1abc123def456ghi789jkl012mno345pqr678stu901vwx234"
    invalid: "cosmos1abc123..." # 错误的地址前缀
    invalid: "cosmwasm1abc" # 地址长度不足
```

### 2. 投注金额验证

```yaml
bet_amount_validation:
  pattern: '^[0-9]+$'
  minimum: "1000"
  maximum: "1000000"
  description: "投注金额验证"
  examples:
    valid: "10000" # 1万代币
    valid: "1000" # 最小投注
    invalid: "999" # 低于最小值
    invalid: "1000001" # 超过最大值
    invalid: "1.5" # 不能有小数
    invalid: "-1000" # 不能为负数
```

### 3. 投注参数验证

```yaml
betting_validation:
  bet_number:
    type: integer
    minimum: 0
    maximum: 999
    description: "投注数字验证"
    examples:
      valid: 123
      valid: 0
      valid: 999
      invalid: 1000 # 超过最大值
  lucky_numbers_count:
    type: integer
    minimum: 1
    maximum: 1000000
    description: "投注码总数量验证（投注码总数必须等于投注金额K）"
    examples:
      valid: 1
      valid: 1000
      valid: 1000000
      invalid: 0 # 小于最小值
      invalid: 1000001 # 超过最大值
```

### 4. 承诺哈希验证

```yaml
commitment_hash_validation:
  pattern: '^[a-f0-9]{64}$'
  description: "SHA256哈希格式验证"
  examples:
    valid: "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"
    invalid: "a1b2c3d4e5f6..." # 长度不足
    invalid: "g1h2i3j4k5l6..." # 包含无效字符
```

## 📊 状态码映射

```yaml
status_code_mapping:
  success:
    http_status: 200
    cosmwasm_status: "success"
    description: "操作成功"
  
  bad_request:
    http_status: 400
    cosmwasm_status: "failure"
    description: "请求参数错误"
    error_codes:
      - "INVALID_PHASE"
      - "INVALID_COMMITMENT"
      - "INVALID_LUCKY_NUMBERS"
      - "ALREADY_BET"
      - "NOT_REVEALED"
      - "INSUFFICIENT_FUNDS"
      - "INVALID_BET_AMOUNT"
      - "REENTRANCY_DETECTED"
  
  unauthorized:
    http_status: 401
    cosmwasm_status: "failure"
    description: "权限不足"
    error_codes:
      - "UNAUTHORIZED"
  
  service_unavailable:
    http_status: 503
    cosmwasm_status: "failure"
    description: "服务不可用"
    error_codes:
      - "SYSTEM_PAUSED"
```

## 🔄 版本兼容性

```yaml
version_compatibility:
  current_version: "1.0.0"
  supported_versions:
    - "1.0.0"
  
  breaking_changes:
    v1.0.0:
      - "初始版本发布"
      - "基础3D彩票功能"
      - "三阶段投注系统"
  
  migration_guide:
    initial_deployment:
      - "首次部署无需迁移"
      - "配置彩票参数"
      - "设置权限控制"
```

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2024-01-XX | 初始接口规范创建 | AI Assistant |

---

**注意**: 本文档是AI之间、系统与系统之间交互的"法律文书"，任何接口变更都必须同步更新本文档，并通知所有相关方。
