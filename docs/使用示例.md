# DD 3D 彩票智能合约使用示例

## 概述

DD 3D 彩票智能合约是一个基于 CosmWasm 的去中心化彩票系统，实现基于区块链高度的三阶段投注机制。

## 功能特性

- **三阶段系统**：承诺阶段、中奖揭秘阶段、结算阶段
- **自动阶段切换**：基于区块链高度自动切换
- **去中心化随机数生成**：使用dd_algorithms_lib库基于所有参与者随机数生成中奖号码
- **多级奖金分配**：一等奖
- **安全防护**：防重入攻击、访问控制、输入验证

### 🎲 去中心化随机数安全特性

**核心安全设计**：随机数质量依赖用户输入，这是去中心化随机数系统的重要安全特性。

**安全优势**：
- **抗单点操控**：任何单一方都无法控制随机数结果
- **集体安全**：只有控制全部参与者才能控制随机数结果
- **公平透明**：所有参与者共同参与随机数生成过程
- **可验证性**：随机数生成过程完全透明，结果可验证

**安全保证**：
- 攻击者需要控制**所有参与者**才能操控随机数
- 随着参与者数量增加，操控难度呈指数级增长
- 即使部分参与者提供弱随机数，系统仍能保持整体安全性

## 使用流程

### 1. 部署合约

```bash
# 使用部署脚本
./scripts/deploy.sh --admin archway1... --chain-id archway-1

# 或手动部署
archwayd tx wasm store target/wasm32-unknown-unknown/release/dd_3d_lottery.wasm \
  --from <your-key> \
  --gas auto \
  --gas-adjustment 1.3 \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443 \
  --yes
```

### 2. 实例化合约

```bash
archwayd tx wasm instantiate <code-id> '{
  "admin": "archway1...",
  "service_fee_rate": "0.1",
  "min_bet_amount": "1000",
  "max_bet_amount": "1000000"
}' \
  --from <your-key> \
  --admin archway1... \
  --label "DD 3D Lottery" \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443 \
  --yes
```

### 3. 投注（承诺阶段）

在区块链高度 % 10000 = 0-5999 时，用户可以投注：

**客户端计算承诺哈希**：
```javascript
// 用户生成随机数种子和投注码
// 假设用户转移了5个基础代币，可以获得5个投注码
const lucky_numbers = [123, 456, 123, 789, 123]; // 5个投注码，允许重复
const random_seed = "my_secret_seed_123";
const bet_amount = 5000; // 投注金额

// 计算承诺哈希（使用投注数量）
const commitment_data = bet_amount + '|' + lucky_numbers.join('|') + '|' + random_seed;
const commitment_hash = sha256(commitment_data);
```

**发送投注交易**：
```bash
archwayd tx wasm execute <contract-address> '{
  "place_bet": {
    "commitment_hash": "a1b2c3d4e5f6789..."
  }
}' \
  --from <your-key> \
  --amount 5000uusd \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443 \
  --yes
```

### 4. 揭秘随机数种子（中奖揭秘阶段）

在区块链高度 % 10000 = 6000-8999 时，用户需要揭秘：

```bash
archwayd tx wasm execute <contract-address> '{
  "reveal_random": {
    "lucky_numbers": [123, 456, 123, 789, 123],
    "random_seed": "my_secret_seed_123"
  }
}' \
  --from <your-key> \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443 \
  --yes
```

### 5. 结算彩票（结算阶段）

在区块链高度 % 10000 = 9000-9999 时，系统自动结算：

```bash
archwayd tx wasm execute <contract-address> '{
  "settle_lottery": {}
}' \
  --from <your-key> \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443 \
  --yes
```

**结算过程**：
1. 系统收集所有参与者的随机数种子
2. 使用dd_algorithms_lib的get_one_dd_3d_rand_num函数计算中奖号码
3. 根据中奖号码分配奖金
4. 更新统计信息

## 查询操作

### 查询当前阶段

```bash
archwayd query wasm contract-state smart <contract-address> '{
  "get_current_phase": {}
}' \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443
```

### 查询当前会话

```bash
archwayd query wasm contract-state smart <contract-address> '{
  "get_current_session": {}
}' \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443
```

### 查询参与者信息

```bash
archwayd query wasm contract-state smart <contract-address> '{
  "get_participant_info": {
    "participant": "archway1..."
  }
}' \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443
```

### 查询彩票结果

```bash
archwayd query wasm contract-state smart <contract-address> '{
  "get_lottery_result": {
    "session_id": "session_12345"
  }
}' \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443
```

### 查询系统配置

```bash
archwayd query wasm contract-state smart <contract-address> '{
  "get_config": {}
}' \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443
```

### 查询统计信息

```bash
archwayd query wasm contract-state smart <contract-address> '{
  "get_stats": {}
}' \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443
```

## 管理员操作

### 更新配置

```bash
archwayd tx wasm execute <contract-address> '{
  "update_config": {
    "service_fee_rate": "0.15",
    "min_bet_amount": "2000",
    "max_bet_amount": "2000000"
  }
}' \
  --from <admin-key> \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443 \
  --yes
```

### 紧急暂停

```bash
archwayd tx wasm execute <contract-address> '{
  "emergency_pause": {
    "paused": true
  }
}' \
  --from <admin-key> \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443 \
  --yes
```

### 提取服务费

```bash
archwayd tx wasm execute <contract-address> '{
  "withdraw_service_fee": {
    "amount": "10000"
  }
}' \
  --from <admin-key> \
  --chain-id archway-1 \
  --node https://rpc.archway.io:443 \
  --yes
```

## 阶段说明

### 承诺阶段 (0-5999)
- 用户可以投注并设置随机数种子
- **客户端计算承诺哈希**：SHA256(投注数量 + "|" + 投注码1 + "|" + 投注码2 + "|" + ... + 投注码K + "|" + 随机种子)
- 投注金额：1,000-1,000,000个基础代币（基础代币的整数倍）
- **重要限制**：单个幸运号码最多只能出现1000次
- **投注限制**：最大投注金额为1,000,000个基础代币（1000×1000）
- 投注码：K个投注码，每个对应0-999的幸运数字（K等于转移的基础代币数量）
- 随机种子：用户自定义字符串
- **只发送承诺哈希，不发送原始数据**
- **允许选择重复的幸运数字**

### 中奖揭秘阶段 (6000-8999)
- 用户需要揭秘随机数种子和投注码
- **重要验证**：提供的投注码数量必须等于承诺阶段转移的代币数量
- 智能合约验证承诺哈希
- 未揭秘的参与者将被视为弃权
- **发送原始数据供验证**

### 结算阶段 (9000-9999)
- 系统收集所有参与者的随机数种子
- 使用dd_algorithms_lib的get_one_dd_3d_rand_num函数计算中奖号码
- 分配奖金
- 一等奖：如果用户的投注码中有几个对应的幸运数字等于中奖号码，就中奖几次

## 奖金分配

- **总奖金池**：当期销售额的90%
- **服务费**：当期销售额的10%
- **固定奖金**：每名中奖者800个基础代币
- **平分奖金**：如果奖金池不足，则平分

## 安全注意事项

1. **承诺哈希安全**：客户端必须正确计算承诺哈希，确保数据一致性
2. **随机种子安全**：请使用强随机种子，不要使用可预测的值
3. **时间窗口**：注意各阶段的时间窗口，错过将无法参与
4. **投注金额**：确保投注金额在允许范围内
5. **网络状态**：确保网络连接稳定，避免交易失败
6. **数据保护**：承诺阶段不要泄露原始数据，只在中奖揭秘阶段发送

## 常见问题

### Q: 如何知道当前处于哪个阶段？
A: 使用 `get_current_phase` 查询接口，或查看区块链高度 % 10000 的值。

### Q: 如何计算承诺哈希？
A: 承诺哈希 = SHA256(投注数量 + "|" + 投注码1 + "|" + 投注码2 + "|" + ... + 投注码K + "|" + 随机种子)。例如：SHA256("5000|123|456|123|789|123|my_secret")。

### Q: 承诺哈希验证失败怎么办？
A: 检查投注码和随机种子是否与承诺阶段使用的一致，确保哈希计算正确。

### Q: 中奖揭秘阶段忘记揭秘怎么办？
A: 未揭秘的参与者将被视为弃权，无法获得奖金。

### Q: 中奖揭秘阶段提供的投注码数量不对怎么办？
A: 系统会验证投注码数量必须等于承诺阶段转移的代币数量。如果数量不匹配，交易会失败并返回错误。

### Q: 单个幸运号码可以重复多少次？
A: 单个幸运号码最多只能出现1000次。如果超过这个限制，交易会失败。

### Q: 最大投注金额是多少？
A: 最大投注金额为1,000,000个基础代币（1000×1000），这是为了确保单个幸运号码不会超过1000次限制。

### Q: 基础代币是什么？如何设置？
A: 基础代币是系统使用的代币类型，由管理员在合约实例化时设置。管理员可以通过 `update_config` 函数更新代币类型。奖金分配使用相同的基础代币。

### Q: 如何查看历史彩票结果？
A: 使用 `get_lottery_result` 查询接口，传入对应的 session_id。

### Q: 管理员可以修改中奖结果吗？
A: 不可以，中奖结果完全由算法计算，管理员无法干预。

## 技术支持

如有问题，请查看：
- [技术文档](docs/技术文档.md)
- [项目 README](README.md)
- [测试用例](tests/integration.rs)

---

**DD 3D 彩票智能合约** - 公平透明的去中心化彩票系统 🎲
