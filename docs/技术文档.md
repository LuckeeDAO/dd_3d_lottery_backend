# DD 3D å½©ç¥¨æ™ºèƒ½åˆçº¦æŠ€æœ¯æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

åŸºäº CosmWasm 2.2.2 æ¡†æ¶æ„å»ºçš„å»ä¸­å¿ƒåŒ– 3D å½©ç¥¨æ™ºèƒ½åˆçº¦ï¼Œå®ç°åŸºäºåŒºå—é“¾é«˜åº¦çš„ä¸‰é˜¶æ®µæŠ•æ³¨ç³»ç»Ÿã€‚

## æ ¸å¿ƒåŠŸèƒ½

### ä¸‰é˜¶æ®µæŠ•æ³¨ç³»ç»Ÿ

æ ¹æ®åŒºå—é“¾é«˜åº¦å¯¹ 10000 å–æ¨¡åçš„å€¼ï¼Œå°†æŠ•æ³¨è¿‡ç¨‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

1. **æ‰¿è¯ºé˜¶æ®µ (0-5999)**ï¼šç”¨æˆ·æŠ•æ³¨å¹¶è®¾ç½®éšæœºæ•°
2. **ä¸­å¥–æ­ç§˜é˜¶æ®µ (6000-8999)**ï¼šç”¨æˆ·æ­ç§˜éšæœºæ•°
3. **ç»“ç®—é˜¶æ®µ (9000-9999)**ï¼šè®¡ç®—ä¸­å¥–å·ç å¹¶åˆ†é…å¥–é‡‘

### æŠ•æ³¨æœºåˆ¶

- ç”¨æˆ·è½¬ç§»Kä¸ªåŸºç¡€ä»£å¸è·å¾—Kæ¬¡å¹¸è¿æ•°å­—æŠ•æ³¨ï¼Œæ¯ä¸ªå¹¸è¿æ•°å­—å¯ä»¥æŠ•æ³¨å¤šæ¬¡ï¼ˆKä¸ºä»»æ„æ­£æ•´æ•°ï¼‰
- **é‡è¦é™åˆ¶**ï¼šå•ä¸ªå¹¸è¿å·ç æœ€å¤šåªèƒ½å‡ºç°1000æ¬¡
- **æŠ•æ³¨é™åˆ¶**ï¼šæœ€å¤§æŠ•æ³¨é‡‘é¢ä¸º1,000,000ä¸ªåŸºç¡€ä»£å¸
- **æ•°é‡é™åˆ¶**ï¼šå¹¸è¿æ•°å­—æ€»æ•°é‡ï¼ˆæŠ•æ³¨å€æ•°ä¹‹å’Œï¼‰æœ€å¤§ä¸º1,000,000ä¸ª
- **æ‰¿è¯ºé˜¶æ®µ**ï¼šç”¨æˆ·è®¾ç½®éšæœºæ•°ç§å­å’Œå¹¸è¿æ•°å­—æŠ•æ³¨åˆ—è¡¨ï¼Œè®¡ç®—æ‰¿è¯ºå“ˆå¸Œï¼Œåªå‘é€å“ˆå¸Œå€¼
- **ä¸­å¥–æ­ç§˜é˜¶æ®µ**ï¼šç”¨æˆ·å‘é€åŸå§‹éšæœºæ•°ç§å­å’Œå¹¸è¿æ•°å­—æŠ•æ³¨åˆ—è¡¨ä¾›éªŒè¯
- **éšæœºæ•°ç§å­**ï¼š0-999ä¹‹é—´çš„æ•°å­—ï¼Œç›´æ¥å†³å®šæœ€ç»ˆä¸­å¥–å¹¸è¿æ•°å­—ï¼Œä»»ä½•å®¢æˆ·ç«¯éƒ½å¯ä»¥éªŒè¯ï¼ŒæŠ—åˆè°‹
  - **é‡è¦**ï¼šä¸­å¥–æ­ç§˜é˜¶æ®µæä¾›çš„æ‰€æœ‰å¹¸è¿æ•°å­—æŠ•æ³¨å€æ•°ä¹‹å’Œå¿…é¡»ç­‰äºæ‰¿è¯ºé˜¶æ®µè½¬ç§»çš„ä»£å¸æ•°é‡K
  - å¦‚æœè½¬ç§»1000ä¸ªä»£å¸ï¼Œå¯ä»¥æŠ•æ³¨123å·ç 1000æ¬¡ï¼Œæˆ–è€…æŠ•æ³¨123å·ç 500æ¬¡+456å·ç 500æ¬¡ï¼Œåªè¦æ€»å’Œç­‰äº1000å³å¯
- å¹¸è¿æ•°å­—å–å€¼èŒƒå›´ï¼š0-999
- ç³»ç»Ÿé™åˆ¶æŠ•æ³¨é‡‘é¢èŒƒå›´ï¼š1,000-1,000,000ä¸ªåŸºç¡€ä»£å¸ï¼ˆåŸºç¡€ä»£å¸çš„æ•´æ•°å€ï¼‰
- å…è®¸é€‰æ‹©é‡å¤çš„å¹¸è¿æ•°å­—ï¼ˆé€šè¿‡é‡å¤æŠ•æ³¨å®ç°ï¼‰
- **æŠ•æ³¨æœºåˆ¶**ï¼šæŠ•æ³¨é‡‘é¢Kå¿…é¡»ç­‰äºæ‰€æœ‰å¹¸è¿æ•°å­—çš„æŠ•æ³¨å€æ•°ä¹‹å’Œ

### å¥–é‡‘åˆ†é…

- å½“æœŸé”€å”®é¢çš„ 90% ä½œä¸ºå¥–é‡‘æ± 
- 10% ä½œä¸ºè½¯ä»¶æœåŠ¡è´¹
- ä¸€ç­‰å¥–ï¼šå¦‚æœç”¨æˆ·é€‰æ‹©çš„å¹¸è¿æ•°å­—ä¸­æœ‰å‡ ä¸ªç­‰äºä¸­å¥–å·ç ï¼Œå°±ä¸­å¥–å‡ æ¬¡
- ä¸­å¥–å·ç æ˜¯ç”±æ‰€æœ‰ç”¨æˆ·è®¾ç½®çš„éšæœºæ•°ç§å­ï¼ˆ0-999ä¹‹é—´çš„æ•°å­—ï¼‰ç›´æ¥å†³å®šçš„ï¼Œä»»ä½•å®¢æˆ·ç«¯éƒ½å¯ä»¥éªŒè¯ï¼ŒæŠ—åˆè°‹
- æ²¡æœ‰äºŒç­‰å¥–ä¸ä¸‰ç­‰å¥–ï¼Œåªæœ‰ä¸€ä¸ªå¥–é¡¹ï¼Œå°±æ˜¯ä¸€ç­‰å¥–
- å¦‚æœå¥–é‡‘æ± å­é‡‘é¢å¤§äºä¸­å¥–è€…æ•°é‡Ã—800ï¼Œåˆ™æ¯åä¸­å¥–è€…å›ºå®šè·å¾—800ä¸ªåŸºç¡€ä»£å¸
- å¦‚æœå¥–é‡‘æ± å­é‡‘é¢å°äºä¸­å¥–è€…æ•°é‡Ã—800ï¼Œåˆ™æ‰€æœ‰ä¸­å¥–è€…å¹³åˆ†å¥–é‡‘æ± 

## æŠ€æœ¯æ¶æ„

### ä¾èµ–æ¡†æ¶

```toml
[dependencies]
cosmwasm-schema = { version = "2.2.2", default-features = false }
cosmwasm-std = "2.2.2"
cw-storage-plus = "2"
cw2 = "2"
cw-utils = "2.0"
schemars = "0.8"
serde = { version = "1.0", default-features = false, features = ["derive"] }
thiserror = "1.0"
sha2 = "0.10"
dd_algorithms_lib = "0.1.0"  # å»ä¸­å¿ƒåŒ–ç®—æ³•åº“
```

### é¡¹ç›®ç»“æ„

```
dd_3d_lottery/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ contract.rs         # åˆçº¦å…¥å£ç‚¹
â”‚   â”œâ”€â”€ execute.rs          # æ‰§è¡Œæ¶ˆæ¯å¤„ç†
â”‚   â”œâ”€â”€ query.rs            # æŸ¥è¯¢æ¶ˆæ¯å¤„ç†
â”‚   â”œâ”€â”€ msg.rs              # æ¶ˆæ¯å®šä¹‰
â”‚   â”œâ”€â”€ state.rs            # çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ error.rs            # é”™è¯¯å®šä¹‰
â”‚   â”œâ”€â”€ phase_manager.rs    # é˜¶æ®µç®¡ç†
â”‚   â”œâ”€â”€ lottery_logic.rs    # å½©ç¥¨é€»è¾‘
â”‚   â”œâ”€â”€ reward_system.rs    # å¥–åŠ±ç³»ç»Ÿ
â”‚   â””â”€â”€ lib.rs              # åº“å…¥å£
â”œâ”€â”€ tests/                  # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ scripts/                # éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ docs/                   # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ Cargo.toml             # é¡¹ç›®é…ç½®
â””â”€â”€ README.md              # é¡¹ç›®è¯´æ˜
```

## æ•°æ®ç»“æ„è®¾è®¡

### æ ¸å¿ƒçŠ¶æ€

```rust
// å½©ç¥¨ä¼šè¯
pub struct LotterySession {
    pub session_id: String,
    pub phase: LotteryPhase,
    pub total_pool: Uint128,
    pub participants: Vec<Participant>,
    pub created_height: u64,
    pub service_fee_rate: Decimal,
}

// å‚ä¸è€…ä¿¡æ¯
pub struct Participant {
    pub address: Addr,
    pub bet_amount: Uint128,
    pub lucky_numbers: Vec<u16>,
    pub random_seed: Option<String>,
    pub revealed: bool,
    pub commitment_hash: Option<String>,
}

// å½©ç¥¨é˜¶æ®µ
pub enum LotteryPhase {
    Commitment,    // æ‰¿è¯ºé˜¶æ®µ (0-5999)
    Reveal,        // ä¸­å¥–æ­ç§˜é˜¶æ®µ (6000-8999)
    Settlement,    // ç»“ç®—é˜¶æ®µ (9000-9999)
}
```

### å­˜å‚¨æ˜ å°„

```rust
// å½“å‰å½©ç¥¨ä¼šè¯
pub const CURRENT_SESSION: Item<LotterySession> = Item::new("current_session");

// å‚ä¸è€…æ‰¿è¯º
pub const COMMITMENTS: Map<&Addr, Commitment> = Map::new("commitments");

// å½©ç¥¨å†å²
pub const LOTTERY_HISTORY: Map<u64, LotteryResult> = Map::new("lottery_history");

// ç³»ç»Ÿé…ç½®
pub const CONFIG: Item<Config> = Item::new("config");
```

## æ¶ˆæ¯æ¥å£

### å®ä¾‹åŒ–æ¶ˆæ¯

```json
{
  "admin": "cosmwasm1...",
  "service_fee_rate": "0.1",
  "min_bet_amount": "1000",
  "max_bet_amount": "1000000"
}
```

### æ‰§è¡Œæ¶ˆæ¯

```json
{
  "place_bet": {
    "commitment_hash": "a1b2c3d4e5f6..."
  }
}
```

```json
{
  "reveal_random": {
    "lucky_numbers": [123, 456, 789],
    "random_seed": "user_random_string"
  }
}
```

```json
{
  "settle_lottery": {}
}
```

### æŸ¥è¯¢æ¶ˆæ¯

```json
{
  "get_current_session": {}
}
```

```json
{
  "get_participant_info": {
    "participant": "cosmwasm1..."
  }
}
```

```json
{
  "get_lottery_result": {
    "session_id": "session_123"
  }
}
```

## æ ¸å¿ƒç®—æ³•

### æ‰¿è¯ºå“ˆå¸Œè®¡ç®—

æ‰¿è¯ºå“ˆå¸Œç”¨äºåœ¨æ‰¿è¯ºé˜¶æ®µéšè—ç”¨æˆ·çš„å¹¸è¿æ•°å­—å’Œéšæœºç§å­ï¼Œç¡®ä¿å…¬å¹³æ€§ï¼š

```rust
pub fn generate_commitment_hash(
    lucky_numbers: &[u16],
    random_seed: &str,
    bet_amount: u128,
) -> String {
    // ä½¿ç”¨æŠ•æ³¨æ•°é‡è€Œä¸æ˜¯å¹¸è¿æ•°å­—æ•°é‡ï¼Œé¿å…å“ˆå¸Œç¢°æ’
    let mut commitment_data = format!("{}|", bet_amount);
    for (i, num) in lucky_numbers.iter().enumerate() {
        if i > 0 {
            commitment_data.push('|');
        }
        commitment_data.push_str(&num.to_string());
    }
    commitment_data.push('|');
    commitment_data.push_str(random_seed);
    
    // è®¡ç®—SHA256å“ˆå¸Œ
    let mut hasher = Sha256::new();
    hasher.update(commitment_data.as_bytes());
    format!("{:x}", hasher.finalize())
}
```

**ç¤ºä¾‹**ï¼š
- æŠ•æ³¨æ•°é‡ï¼š5000
- å¹¸è¿æ•°å­—ï¼š[123, 456, 789]
- éšæœºç§å­ï¼š"my_secret_seed_123"
- æ‰¿è¯ºæ•°æ®ï¼š"5000|123|456|789|my_secret_seed_123"
- æ‰¿è¯ºå“ˆå¸Œï¼šSHA256("5000|123|456|789|my_secret_seed_123")

### é˜¶æ®µåˆ¤æ–­

```rust
pub fn get_current_phase(block_height: u64) -> LotteryPhase {
    let phase_mod = block_height % 10000;
    match phase_mod {
        0..=5999 => LotteryPhase::Commitment,
        6000..=8999 => LotteryPhase::Reveal,
        9000..=9999 => LotteryPhase::Settlement,
        _ => LotteryPhase::Commitment,
    }
}
```

### ä¸­å¥–å·ç è®¡ç®—

```rust
use dd_algorithms_lib::get_one_dd_3d_rand_num;

pub fn calculate_winning_number(participants: &[Participant]) -> Result<u16, ContractError> {
    let mut random_values = Vec::new();
    
    // æ”¶é›†æ‰€æœ‰å‚ä¸è€…çš„éšæœºæ•°ç§å­
    for participant in participants {
        if let Some(seed) = &participant.random_seed {
            // å°†éšæœºç§å­è½¬æ¢ä¸ºu128æ•°å€¼
            let seed_value = hash_to_u128(seed);
            random_values.push(seed_value);
        }
    }
    
    if random_values.is_empty() {
        return Err(ContractError::NoParticipants);
    }
    
    // ä½¿ç”¨dd_algorithms_libçš„å»ä¸­å¿ƒåŒ–ç®—æ³•è®¡ç®—ä¸­å¥–å·ç 
    let n = random_values.len();
    let k = 1000; // 3Då½©ç¥¨å·ç èŒƒå›´0-999
    let mut result = 0u128;
    
    get_one_dd_3d_rand_num(&random_values, n, k, &mut result)
        .map_err(|_| ContractError::RandomGenerationFailed)?;
    
    Ok(result as u16)
}
```

### å¥–é‡‘åˆ†é…ç®—æ³•

#### åˆ†é…è§„åˆ™

æœ¬ç³»ç»Ÿé‡‡ç”¨å…¬å¹³çš„å¥–é‡‘åˆ†é…æœºåˆ¶ï¼Œç¡®ä¿æ‰€æœ‰ä¸­å¥–è€…è·å¾—ç›¸åŒçš„å¥–é‡‘é‡‘é¢ï¼š

**1. å›ºå®šå¥–é‡‘åˆ†é…ï¼ˆä¼˜å…ˆç­–ç•¥ï¼‰**
- **è§¦å‘æ¡ä»¶ï¼š** å¥–é‡‘æ± é‡‘é¢ â‰¥ ä¸­å¥–è€…æ•°é‡ Ã— 800ä¸ªåŸºç¡€ä»£å¸
- **åˆ†é…æ–¹å¼ï¼š** æ¯åä¸­å¥–è€…å›ºå®šè·å¾—800ä¸ªåŸºç¡€ä»£å¸
- **ä¼˜åŠ¿ï¼š** ä¿è¯ä¸­å¥–è€…è·å¾—ç¨³å®šçš„å¥–é‡‘

**2. å¹³åˆ†å¥–é‡‘åˆ†é…ï¼ˆå…œåº•ç­–ç•¥ï¼‰**
- **è§¦å‘æ¡ä»¶ï¼š** å¥–é‡‘æ± é‡‘é¢ < ä¸­å¥–è€…æ•°é‡ Ã— 800ä¸ªåŸºç¡€ä»£å¸
- **åˆ†é…æ–¹å¼ï¼š** æ‰€æœ‰ä¸­å¥–è€…å¹³åˆ†å¥–é‡‘æ± 
- **è®¡ç®—æ–¹å¼ï¼š** ä½¿ç”¨æ•´æ•°é™¤æ³•ï¼Œç¡®ä¿å…¬å¹³åˆ†é…
- **ä½™æ•°å¤„ç†ï¼š** ä½™æ•°éƒ¨åˆ†ä¿ç•™åœ¨åˆçº¦èµ„é‡‘æ± ä¸­

#### åˆ†é…ç¤ºä¾‹

**ç¤ºä¾‹1ï¼šå›ºå®šå¥–é‡‘åˆ†é…**
- å¥–é‡‘æ± ï¼š10,000ä¸ªä»£å¸
- ä¸­å¥–è€…ï¼š5äºº
- è®¡ç®—ï¼š5 Ã— 800 = 4,000 < 10,000 âœ…
- ç»“æœï¼šæ¯äººè·å¾—800ä¸ªä»£å¸ï¼Œå‰©ä½™6,000ä¸ªä»£å¸ä¿ç•™åœ¨èµ„é‡‘æ± 

**ç¤ºä¾‹2ï¼šå¹³åˆ†å¥–é‡‘åˆ†é…**
- å¥–é‡‘æ± ï¼š1,500ä¸ªä»£å¸
- ä¸­å¥–è€…ï¼š3äºº
- è®¡ç®—ï¼š3 Ã— 800 = 2,400 > 1,500 âŒ
- ç»“æœï¼šæ¯äººè·å¾—500ä¸ªä»£å¸ï¼ˆ1,500 Ã· 3 = 500ï¼‰ï¼Œä½™æ•°0

**ç¤ºä¾‹3ï¼šæœ‰ä½™æ•°çš„å¹³åˆ†åˆ†é…**
- å¥–é‡‘æ± ï¼š1,000ä¸ªä»£å¸
- ä¸­å¥–è€…ï¼š3äºº
- è®¡ç®—ï¼š3 Ã— 800 = 2,400 > 1,000 âŒ
- ç»“æœï¼šæ¯äººè·å¾—333ä¸ªä»£å¸ï¼ˆ1,000 Ã· 3 = 333ï¼‰ï¼Œä½™æ•°1ä¸ªä»£å¸ä¿ç•™åœ¨èµ„é‡‘æ± 

#### é‡è¦è¯´æ˜

âš ï¸ **ç†æ€§æŠ•æ³¨æé†’ï¼š** å½“èµ„é‡‘æ± ä¸è¶³ä»¥åˆ†é…å›ºå®šå¥–é‡‘æ—¶ï¼Œç³»ç»Ÿå°†é‡‡ç”¨å¹³åˆ†æœºåˆ¶ã€‚è¯·ç”¨æˆ·ç†æ€§æŠ•æ³¨ï¼Œäº†è§£å¥–é‡‘åˆ†é…è§„åˆ™ï¼Œé¿å…å› èµ„é‡‘æ± ä¸è¶³å¯¼è‡´çš„å¥–é‡‘å‡å°‘ã€‚

ğŸ’¡ **ä½™æ•°å¤„ç†ï¼š** å¹³åˆ†åˆ†é…äº§ç”Ÿçš„ä½™æ•°å°†æ°¸ä¹…ä¿ç•™åœ¨åˆçº¦èµ„é‡‘æ± ä¸­ï¼Œè¿™æ˜¯ç¡®ä¿åˆ†é…å…¬å¹³æ€§çš„å¿…è¦è®¾è®¡ï¼Œæ‰€æœ‰ä¸­å¥–è€…å°†è·å¾—å®Œå…¨ç›¸åŒçš„å¥–é‡‘é‡‘é¢ã€‚

#### ä»£ç å®ç°

```rust
pub fn distribute_rewards(
    winners: &mut Vec<Winner>,
    total_reward_pool: Uint128,
) -> Result<Vec<Winner>, ContractError> {
    // å¦‚æœæ²¡æœ‰ä¸­å¥–è€…ï¼Œç›´æ¥è¿”å›ç©ºåˆ—è¡¨
    if winners.is_empty() {
        return Ok(vec![]);
    }
    
    let winner_count = Uint128::from(winners.len() as u128);
    let fixed_reward_per_winner = Uint128::from(800u128); // å›ºå®šå¥–é‡‘ï¼š800ä¸ªåŸºç¡€ä»£å¸
    let total_fixed_rewards = winner_count * fixed_reward_per_winner;
    
    // è®¡ç®—æ¯ä¸ªä¸­å¥–è€…åº”å¾—çš„å¥–é‡‘é‡‘é¢
    let reward_per_winner = if total_reward_pool >= total_fixed_rewards {
        // æƒ…å†µ1ï¼šå¥–é‡‘æ± å……è¶³ï¼Œä½¿ç”¨å›ºå®šå¥–é‡‘åˆ†é…
        // æ¯åä¸­å¥–è€…è·å¾—800ä¸ªåŸºç¡€ä»£å¸
        fixed_reward_per_winner
    } else {
        // æƒ…å†µ2ï¼šå¥–é‡‘æ± ä¸è¶³ï¼Œä½¿ç”¨å¹³åˆ†åˆ†é…
        // æ‰€æœ‰ä¸­å¥–è€…å¹³åˆ†å¥–é‡‘æ± ï¼Œä½¿ç”¨æ•´æ•°é™¤æ³•ç¡®ä¿å…¬å¹³
        // ä½™æ•°éƒ¨åˆ†å°†ä¿ç•™åœ¨åˆçº¦èµ„é‡‘æ± ä¸­
        total_reward_pool / winner_count
    };
    
    // æ›´æ–°æ‰€æœ‰ä¸­å¥–è€…çš„å¥–é‡‘é‡‘é¢
    // æ³¨æ„ï¼šæ‰€æœ‰ä¸­å¥–è€…å°†è·å¾—å®Œå…¨ç›¸åŒçš„å¥–é‡‘é‡‘é¢ï¼Œç¡®ä¿åˆ†é…å…¬å¹³æ€§
    for winner in winners.iter_mut() {
        winner.reward_amount = reward_per_winner;
    }
    
    Ok(winners.clone())
}
```

## å®‰å…¨ç‰¹æ€§

### ğŸ² å»ä¸­å¿ƒåŒ–éšæœºæ•°å®‰å…¨æœºåˆ¶

**æ ¸å¿ƒè®¾è®¡ç†å¿µ**ï¼šéšæœºæ•°è´¨é‡ä¾èµ–ç”¨æˆ·è¾“å…¥ï¼Œè¿™æ˜¯å»ä¸­å¿ƒåŒ–éšæœºæ•°ç³»ç»Ÿçš„é‡è¦å®‰å…¨ç‰¹æ€§ã€‚

#### å®‰å…¨ä¼˜åŠ¿

1. **æŠ—å•ç‚¹æ“æ§**
   - ä»»ä½•å•ä¸€æ–¹éƒ½æ— æ³•æ§åˆ¶éšæœºæ•°ç»“æœ
   - ç³»ç»Ÿç®¡ç†å‘˜ã€çŸ¿å·¥ã€éªŒè¯è€…éƒ½æ— æ³•å•ç‹¬æ“æ§ç»“æœ

2. **é›†ä½“å®‰å…¨**
   - åªæœ‰æ§åˆ¶å…¨éƒ¨å‚ä¸è€…æ‰èƒ½æ§åˆ¶éšæœºæ•°ç»“æœ
   - æ”»å‡»è€…éœ€è¦åŒæ—¶æ§åˆ¶æ‰€æœ‰å‚ä¸è€…çš„éšæœºç§å­

3. **å…¬å¹³é€æ˜**
   - æ‰€æœ‰å‚ä¸è€…å…±åŒå‚ä¸éšæœºæ•°ç”Ÿæˆè¿‡ç¨‹
   - éšæœºæ•°ç”Ÿæˆè¿‡ç¨‹å®Œå…¨é€æ˜ï¼Œç»“æœå¯éªŒè¯

4. **å¯éªŒè¯æ€§**
   - ä»»ä½•äººéƒ½å¯ä»¥éªŒè¯éšæœºæ•°ç”Ÿæˆè¿‡ç¨‹
   - ä½¿ç”¨å…¬å¼€çš„å»ä¸­å¿ƒåŒ–ç®—æ³•ï¼Œæ— éšè—é€»è¾‘

#### æŠ€æœ¯å®ç°

```rust
pub fn calculate_winning_number(participants: &[Participant]) -> Result<u16, ContractError> {
    // æ”¶é›†æ‰€æœ‰å·²æ­ç§˜çš„éšæœºç§å­
    let mut random_values = Vec::new();
    
    for participant in participants {
        if let Some(seed) = &participant.random_seed {
            if participant.revealed {
                // å°†éšæœºç§å­è½¬æ¢ä¸ºu128æ•°å€¼
                let seed_value = Self::hash_to_u128(seed);
                random_values.push(seed_value);
            }
        }
    }
    
    // ä½¿ç”¨dd_algorithms_libçš„å»ä¸­å¿ƒåŒ–ç®—æ³•è®¡ç®—ä¸­å¥–å·ç 
    let n = random_values.len();
    let k = 1000; // 3Då½©ç¥¨å·ç èŒƒå›´0-999
    let mut result = 0u128;
    
    get_one_dd_3d_rand_num(&random_values, n, k, &mut result)
        .map_err(|_| ContractError::RandomGenerationFailed)?;
    
    Ok(result as u16)
}
```

#### å®‰å…¨ä¿è¯

1. **æ“æ§éš¾åº¦**
   - æ”»å‡»è€…éœ€è¦æ§åˆ¶**æ‰€æœ‰å‚ä¸è€…**æ‰èƒ½æ“æ§éšæœºæ•°
   - éšç€å‚ä¸è€…æ•°é‡å¢åŠ ï¼Œæ“æ§éš¾åº¦å‘ˆæŒ‡æ•°çº§å¢é•¿

2. **å®¹é”™æ€§**
   - å³ä½¿éƒ¨åˆ†å‚ä¸è€…æä¾›å¼±éšæœºæ•°ï¼Œç³»ç»Ÿä»èƒ½ä¿æŒæ•´ä½“å®‰å…¨æ€§
   - å»ä¸­å¿ƒåŒ–ç®—æ³•èƒ½å¤Ÿå¤„ç†éƒ¨åˆ†æ¶æ„è¾“å…¥

3. **é€æ˜åº¦**
   - éšæœºæ•°ç”Ÿæˆè¿‡ç¨‹å®Œå…¨å…¬å¼€
   - ä»»ä½•äººéƒ½å¯ä»¥éªŒè¯ç»“æœçš„æ­£ç¡®æ€§

#### ä¸ä¼ ç»Ÿéšæœºæ•°çš„å¯¹æ¯”

| ç‰¹æ€§ | ä¼ ç»Ÿéšæœºæ•° | å»ä¸­å¿ƒåŒ–éšæœºæ•° |
|------|------------|----------------|
| æ“æ§é£é™© | å•ç‚¹æ“æ§é£é™©é«˜ | éœ€è¦æ§åˆ¶æ‰€æœ‰å‚ä¸è€… |
| é€æ˜åº¦ | é»‘ç›’æ“ä½œ | å®Œå…¨é€æ˜å¯éªŒè¯ |
| å…¬å¹³æ€§ | ä¾èµ–ä¿¡ä»» | æ•°å­¦ä¿è¯å…¬å¹³ |
| å®‰å…¨æ€§ | ä¸­å¿ƒåŒ–é£é™© | åˆ†å¸ƒå¼å®‰å…¨ |

### é˜²é‡å…¥ä¿æŠ¤

```rust
pub const REENTRANCY_LOCK: Item<bool> = Item::new("reentrancy_lock");

pub fn with_reentrancy_protection<F, R>(
    deps: DepsMut,
    f: F,
) -> Result<R, ContractError>
where
    F: FnOnce(DepsMut) -> Result<R, ContractError>,
{
    if REENTRANCY_LOCK.load(deps.storage)? {
        return Err(ContractError::ReentrancyDetected);
    }
    
    REENTRANCY_LOCK.save(deps.storage, &true)?;
    let result = f(deps);
    REENTRANCY_LOCK.save(deps.storage, &false)?;
    
    result
}
```

### è®¿é—®æ§åˆ¶

```rust
pub fn assert_admin(deps: Deps, sender: &Addr) -> Result<(), ContractError> {
    let config = CONFIG.load(deps.storage)?;
    if sender != &config.admin {
        return Err(ContractError::Unauthorized);
    }
    Ok(())
}
```

### è¾“å…¥éªŒè¯

```rust
pub fn validate_lucky_numbers(numbers: &[u16]) -> Result<(), ContractError> {
    if numbers.len() != 3 {
        return Err(ContractError::InvalidLuckyNumbers);
    }
    
    for &number in numbers {
        if number > 999 {
            return Err(ContractError::InvalidLuckyNumbers);
        }
    }
    
    Ok(())
}
```

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

- é˜¶æ®µåˆ¤æ–­é€»è¾‘æµ‹è¯•
- ä¸­å¥–å·ç è®¡ç®—æµ‹è¯•
- å¥–é‡‘åˆ†é…ç®—æ³•æµ‹è¯•
- è¾“å…¥éªŒè¯æµ‹è¯•

### é›†æˆæµ‹è¯•

- å®Œæ•´æŠ•æ³¨æµç¨‹æµ‹è¯•
- å¤šç”¨æˆ·å¹¶å‘æµ‹è¯•
- è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- é”™è¯¯å¤„ç†æµ‹è¯•

### æ€§èƒ½æµ‹è¯•

- å¤§é‡å‚ä¸è€…å‹åŠ›æµ‹è¯•
- Gas æ¶ˆè€—ä¼˜åŒ–æµ‹è¯•
- å­˜å‚¨æ•ˆç‡æµ‹è¯•

## éƒ¨ç½²æŒ‡å—

### ç¯å¢ƒè¦æ±‚

- Rust 1.70+
- CosmWasm CLI (wasmd)
- cosmwasm-opt (å¯é€‰)

### æ„å»ºæ­¥éª¤

```bash
# æ„å»ºåˆçº¦
cargo build --release --target wasm32-unknown-unknown

# ä¼˜åŒ– WASM
cosmwasm-opt target/wasm32-unknown-unknown/release/dd_3d_lottery.wasm \
  -o target/wasm32-unknown-unknown/release/dd_3d_lottery_optimized.wasm
```

### éƒ¨ç½²å‘½ä»¤

```bash
# ä¸Šä¼ åˆçº¦
wasmd tx wasm store target/wasm32-unknown-unknown/release/dd_3d_lottery.wasm \
  --from <your-key> \
  --gas auto \
  --gas-adjustment 1.3 \
  --chain-id <chain-id> \
  --node <rpc-url> \
  --yes

# å®ä¾‹åŒ–åˆçº¦
wasmd tx wasm instantiate <code-id> '{"admin":"<admin-address>",...}' \
  --from <your-key> \
  --admin <admin-address> \
  --label "DD 3D Lottery" \
  --chain-id <chain-id> \
  --node <rpc-url> \
  --yes
```

## ç›‘æ§å’Œç»´æŠ¤

### å…³é”®æŒ‡æ ‡

- æŠ•æ³¨å‚ä¸ç‡
- å¥–é‡‘åˆ†é…æ•ˆç‡
- Gas æ¶ˆè€—ç»Ÿè®¡
- é”™è¯¯ç‡ç›‘æ§

### ç»´æŠ¤æ“ä½œ

- å®šæœŸæ£€æŸ¥åˆçº¦çŠ¶æ€
- ç›‘æ§å¼‚å¸¸äº¤æ˜“
- æ›´æ–°ç³»ç»Ÿå‚æ•°
- å¤„ç†ç”¨æˆ·æŠ•è¯‰

## é£é™©æ§åˆ¶

### æŠ€æœ¯é£é™©

- æ™ºèƒ½åˆçº¦æ¼æ´
- ç½‘ç»œæ‹¥å µå½±å“
- éšæœºæ•°ç”Ÿæˆå®‰å…¨

### ä¸šåŠ¡é£é™©

- æŠ•æ³¨é‡‘é¢é™åˆ¶
- ä¸­å¥–æ¦‚ç‡æ§åˆ¶
- èµ„é‡‘å®‰å…¨ä¿æŠ¤

### åº”å¯¹æªæ–½

- ä»£ç å®¡è®¡
- å¤šé‡ç­¾å
- ç´§æ€¥æš‚åœæœºåˆ¶
- èµ„é‡‘ä¿é™©

## æœªæ¥è§„åˆ’

### åŠŸèƒ½æ‰©å±•

- å¤šæœŸå½©ç¥¨æ”¯æŒ
- NFT å¥–å“é›†æˆ
- è·¨é“¾æŠ•æ³¨
- ç§»åŠ¨ç«¯é€‚é…

### æŠ€æœ¯ä¼˜åŒ–

- æ€§èƒ½æå‡
- Gas ä¼˜åŒ–
- å­˜å‚¨å‹ç¼©
- æŸ¥è¯¢ä¼˜åŒ–

---

**DD 3D å½©ç¥¨æ™ºèƒ½åˆçº¦** - æ„å»ºå…¬å¹³é€æ˜çš„å»ä¸­å¿ƒåŒ–å½©ç¥¨ç³»ç»Ÿ ğŸ²

