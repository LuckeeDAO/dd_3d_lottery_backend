# DD 3D 彩票智能合约 部署与运维

## 📋 文档信息

- **项目名称**: DD 3D Lottery (3D彩票智能合约)
- **版本**: v1.0
- **文档类型**: 部署与运维
- **创建日期**: 2024-01-XX
- **最后更新**: 2024-01-XX

## 🎯 概述

本文档详细描述了DD 3D Lottery智能合约的部署流程、运维管理、监控告警、故障处理和性能优化等运维相关内容。

## 🚀 部署流程

### 1. 部署环境准备

#### 1.1 环境要求

```yaml
environment_requirements:
  hardware:
    cpu: "4核心以上"
    memory: "8GB以上"
    storage: "100GB以上SSD"
    network: "稳定的网络连接"
  
  software:
    rust: ">= 1.70.0"
    cosmwasm: ">= 2.2.2"
    wasmd: ">= 0.45.0"
    cosmwasm-opt: ">= 0.16.0"
  
  blockchain:
    chain_id: "指定链ID"
    rpc_url: "RPC节点地址"
    gas_price: "Gas价格设置"
    account: "部署账户"
```

#### 1.2 环境配置

```bash
# 1. 安装Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source ~/.cargo/env

# 2. 安装wasmd
git clone https://github.com/CosmWasm/wasmd.git
cd wasmd
make install

# 3. 安装cosmwasm-opt
cargo install cosmwasm-opt

# 4. 配置环境变量
export CHAIN_ID="your-chain-id"
export RPC_URL="https://your-rpc-url"
export GAS_PRICE="0.025stake"
export ACCOUNT_NAME="deployer"
```

### 2. 合约构建

#### 2.1 构建步骤

```bash
# 1. 克隆项目
git clone https://github.com/your-org/dd-3d-lottery.git
cd dd-3d-lottery

# 2. 安装依赖
cargo check

# 3. 运行测试
cargo test

# 4. 构建合约
cargo build --release --target wasm32-unknown-unknown

# 5. 优化WASM
cosmwasm-opt target/wasm32-unknown-unknown/release/dd_3d_lottery.wasm \
  -o target/wasm32-unknown-unknown/release/dd_3d_lottery_optimized.wasm
```

#### 2.2 构建验证

```bash
# 验证WASM文件
wasmd query wasm code-info <code-id>

# 检查文件大小
ls -lh target/wasm32-unknown-unknown/release/dd_3d_lottery_optimized.wasm

# 验证文件完整性
sha256sum target/wasm32-unknown-unknown/release/dd_3d_lottery_optimized.wasm
```

### 3. 合约部署

#### 3.1 部署步骤

```bash
# 1. 上传合约代码
wasmd tx wasm store target/wasm32-unknown-unknown/release/dd_3d_lottery_optimized.wasm \
  --from $ACCOUNT_NAME \
  --gas auto \
  --gas-adjustment 1.3 \
  --chain-id $CHAIN_ID \
  --node $RPC_URL \
  --yes

# 2. 获取代码ID
CODE_ID=$(wasmd query tx <tx-hash> --output json | jq -r '.logs[0].events[0].attributes[0].value')

# 3. 实例化合约
wasmd tx wasm instantiate $CODE_ID '{
  "admin": "cosmwasm1...",
  "service_fee_rate": "0.1",
  "min_bet_amount": "1000",
  "max_bet_amount": "1000000"
}' \
  --from $ACCOUNT_NAME \
  --admin $ADMIN_ADDRESS \
  --label "DD 3D Lottery v1.0" \
  --chain-id $CHAIN_ID \
  --node $RPC_URL \
  --yes

# 4. 获取合约地址
CONTRACT_ADDRESS=$(wasmd query tx <tx-hash> --output json | jq -r '.logs[0].events[0].attributes[0].value')
```

#### 3.2 部署验证

```bash
# 1. 验证合约实例化
wasmd query wasm contract $CONTRACT_ADDRESS

# 2. 测试查询接口
wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"get_config": {}}'

# 3. 测试执行接口
wasmd tx wasm execute $CONTRACT_ADDRESS '{"get_current_phase": {}}' \
  --from $ACCOUNT_NAME \
  --chain-id $CHAIN_ID \
  --node $RPC_URL \
  --yes

# 4. 验证合约版本
wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"get_version": {}}'
```

### 4. 部署脚本

#### 4.1 自动化部署脚本

```bash
#!/bin/bash
# deploy.sh - 自动化部署脚本

set -e

# 配置变量
CHAIN_ID=${CHAIN_ID:-"testnet"}
RPC_URL=${RPC_URL:-"https://rpc.testnet.cosmos.network"}
ACCOUNT_NAME=${ACCOUNT_NAME:-"deployer"}
ADMIN_ADDRESS=${ADMIN_ADDRESS:-"cosmwasm1..."}
SERVICE_FEE_RATE=${SERVICE_FEE_RATE:-"0.1"}
MIN_BET_AMOUNT=${MIN_BET_AMOUNT:-"1000"}
MAX_BET_AMOUNT=${MAX_BET_AMOUNT:-"1000000"}

echo "开始部署DD 3D Lottery合约..."

# 1. 构建合约
echo "构建合约..."
cargo build --release --target wasm32-unknown-unknown

# 2. 优化WASM
echo "优化WASM..."
cosmwasm-opt target/wasm32-unknown-unknown/release/dd_3d_lottery.wasm \
  -o target/wasm32-unknown-unknown/release/dd_3d_lottery_optimized.wasm

# 3. 上传合约
echo "上传合约..."
TX_HASH=$(wasmd tx wasm store target/wasm32-unknown-unknown/release/dd_3d_lottery_optimized.wasm \
  --from $ACCOUNT_NAME \
  --gas auto \
  --gas-adjustment 1.3 \
  --chain-id $CHAIN_ID \
  --node $RPC_URL \
  --yes \
  --output json | jq -r '.txhash')

echo "上传交易哈希: $TX_HASH"

# 4. 等待确认
echo "等待交易确认..."
sleep 10

# 5. 获取代码ID
CODE_ID=$(wasmd query tx $TX_HASH --output json | jq -r '.logs[0].events[0].attributes[0].value')
echo "代码ID: $CODE_ID"

# 6. 实例化合约
echo "实例化合约..."
INSTANTIATE_MSG=$(cat <<EOF
{
  "admin": "$ADMIN_ADDRESS",
  "service_fee_rate": "$SERVICE_FEE_RATE",
  "min_bet_amount": "$MIN_BET_AMOUNT",
  "max_bet_amount": "$MAX_BET_AMOUNT"
}
EOF
)

INSTANTIATE_TX_HASH=$(wasmd tx wasm instantiate $CODE_ID "$INSTANTIATE_MSG" \
  --from $ACCOUNT_NAME \
  --admin $ADMIN_ADDRESS \
  --label "DD 3D Lottery v1.0" \
  --chain-id $CHAIN_ID \
  --node $RPC_URL \
  --yes \
  --output json | jq -r '.txhash')

echo "实例化交易哈希: $INSTANTIATE_TX_HASH"

# 7. 等待确认
echo "等待实例化确认..."
sleep 10

# 8. 获取合约地址
CONTRACT_ADDRESS=$(wasmd query tx $INSTANTIATE_TX_HASH --output json | jq -r '.logs[0].events[0].attributes[0].value')
echo "合约地址: $CONTRACT_ADDRESS"

# 9. 验证部署
echo "验证部署..."
wasmd query wasm contract $CONTRACT_ADDRESS

echo "部署完成！"
echo "合约地址: $CONTRACT_ADDRESS"
echo "代码ID: $CODE_ID"
```

#### 4.2 环境配置脚本

```bash
#!/bin/bash
# setup.sh - 环境配置脚本

set -e

echo "配置DD 3D Lottery部署环境..."

# 1. 检查Rust安装
if ! command -v rustc &> /dev/null; then
    echo "安装Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
    source ~/.cargo/env
fi

# 2. 检查wasmd安装
if ! command -v wasmd &> /dev/null; then
    echo "安装wasmd..."
    git clone https://github.com/CosmWasm/wasmd.git
    cd wasmd
    make install
    cd ..
fi

# 3. 检查cosmwasm-opt安装
if ! command -v cosmwasm-opt &> /dev/null; then
    echo "安装cosmwasm-opt..."
    cargo install cosmwasm-opt
fi

# 4. 创建配置文件
cat > .env <<EOF
CHAIN_ID=testnet
RPC_URL=https://rpc.testnet.cosmos.network
ACCOUNT_NAME=deployer
ADMIN_ADDRESS=cosmwasm1...
SERVICE_FEE_RATE=0.1
MIN_BET_AMOUNT=1000
MAX_BET_AMOUNT=1000000
EOF

echo "环境配置完成！"
echo "请编辑.env文件设置正确的配置参数"
```

## 🔧 运维管理

### 1. 系统监控

#### 1.1 监控指标

```yaml
monitoring_metrics:
  system_metrics:
    - "CPU使用率"
    - "内存使用率"
    - "磁盘使用率"
    - "网络流量"
    - "系统负载"
  
  application_metrics:
    - "合约调用次数"
    - "交易成功率"
    - "Gas消耗统计"
    - "错误率统计"
    - "响应时间"
  
  business_metrics:
    - "投注数量"
    - "奖金分配"
    - "用户活跃度"
    - "收入统计"
    - "中奖率"
```

#### 1.2 监控工具

```yaml
monitoring_tools:
  prometheus:
    description: "指标收集和存储"
    metrics: ["系统指标", "应用指标", "业务指标"]
  
  grafana:
    description: "指标可视化和告警"
    dashboards: ["系统监控", "应用监控", "业务监控"]
  
  alertmanager:
    description: "告警管理"
    channels: ["邮件", "短信", "Slack", "钉钉"]
  
  custom_monitoring:
    description: "自定义监控"
    tools: ["CosmWasm Events", "Blockchain Explorer"]
```

### 2. 日志管理

#### 2.1 日志分类

```yaml
log_categories:
  system_logs:
    - "系统启动日志"
    - "系统错误日志"
    - "性能日志"
    - "安全日志"
  
  application_logs:
    - "合约调用日志"
    - "交易处理日志"
    - "错误处理日志"
    - "业务逻辑日志"
  
  audit_logs:
    - "管理员操作日志"
    - "配置变更日志"
    - "权限变更日志"
    - "安全事件日志"
```

#### 2.2 日志处理

```yaml
log_processing:
  collection:
    tools: ["Fluentd", "Logstash", "Filebeat"]
    sources: ["应用日志", "系统日志", "审计日志"]
  
  storage:
    tools: ["Elasticsearch", "InfluxDB", "ClickHouse"]
    retention: "90天"
    compression: "gzip"
  
  analysis:
    tools: ["Kibana", "Grafana", "Custom Dashboards"]
    alerts: ["错误率告警", "性能告警", "安全告警"]
```

### 3. 备份恢复

#### 3.1 备份策略

```yaml
backup_strategy:
  data_backup:
    frequency: "每日"
    retention: "30天"
    location: "多个地理位置"
    encryption: "AES-256"
  
  configuration_backup:
    frequency: "每次变更"
    retention: "90天"
    location: "版本控制系统"
    encryption: "GPG"
  
  code_backup:
    frequency: "每次发布"
    retention: "永久"
    location: "Git仓库"
    encryption: "Git签名"
```

#### 3.2 恢复流程

```bash
#!/bin/bash
# restore.sh - 数据恢复脚本

set -e

BACKUP_DATE=${1:-$(date -d "yesterday" +%Y%m%d)}
BACKUP_LOCATION="/backup/$BACKUP_DATE"

echo "开始恢复数据到 $BACKUP_DATE..."

# 1. 检查备份文件
if [ ! -d "$BACKUP_LOCATION" ]; then
    echo "错误: 备份目录不存在: $BACKUP_LOCATION"
    exit 1
fi

# 2. 停止服务
echo "停止服务..."
systemctl stop dd-3d-lottery

# 3. 恢复数据
echo "恢复数据..."
cp -r $BACKUP_LOCATION/data/* /var/lib/dd-3d-lottery/
cp -r $BACKUP_LOCATION/config/* /etc/dd-3d-lottery/

# 4. 验证数据完整性
echo "验证数据完整性..."
wasmd query wasm contract $CONTRACT_ADDRESS

# 5. 启动服务
echo "启动服务..."
systemctl start dd-3d-lottery

# 6. 验证服务状态
echo "验证服务状态..."
sleep 10
systemctl status dd-3d-lottery

echo "数据恢复完成！"
```

## 🚨 故障处理

### 1. 故障分类

#### 1.1 故障等级

| 故障等级 | 影响范围 | 响应时间 | 解决时间 | 示例 |
|----------|----------|----------|----------|------|
| P0 - 严重 | 系统完全不可用 | 15分钟 | 2小时 | 合约崩溃、数据丢失 |
| P1 - 高 | 核心功能不可用 | 30分钟 | 4小时 | 投注功能异常、查询失败 |
| P2 - 中 | 部分功能异常 | 2小时 | 8小时 | 性能下降、部分用户受影响 |
| P3 - 低 | 非核心功能异常 | 4小时 | 24小时 | 统计功能异常、文档问题 |

#### 1.2 故障类型

```yaml
fault_types:
  system_faults:
    - "硬件故障"
    - "网络故障"
    - "系统崩溃"
    - "资源耗尽"
  
  application_faults:
    - "合约错误"
    - "数据不一致"
    - "性能问题"
    - "安全漏洞"
  
  business_faults:
    - "投注异常"
    - "奖金分配错误"
    - "用户投诉"
    - "合规问题"
```

### 2. 故障响应流程

#### 2.1 响应流程

```yaml
incident_response:
  detection:
    - "监控告警"
    - "用户报告"
    - "系统检查"
    - "人工发现"
  
  assessment:
    - "故障确认"
    - "影响评估"
    - "优先级确定"
    - "团队通知"
  
  response:
    - "故障隔离"
    - "临时修复"
    - "根本原因分析"
    - "永久修复"
  
  recovery:
    - "服务恢复"
    - "数据验证"
    - "功能测试"
    - "监控确认"
  
  post_incident:
    - "故障总结"
    - "改进措施"
    - "文档更新"
    - "经验分享"
```

#### 2.2 故障处理脚本

```bash
#!/bin/bash
# incident_response.sh - 故障响应脚本

set -e

INCIDENT_ID=${1:-"INC-$(date +%Y%m%d-%H%M%S)"}
SEVERITY=${2:-"P2"}
DESCRIPTION=${3:-"未知故障"}

echo "开始处理故障: $INCIDENT_ID"
echo "严重程度: $SEVERITY"
echo "描述: $DESCRIPTION"

# 1. 创建故障记录
echo "创建故障记录..."
mkdir -p /var/log/incidents/$INCIDENT_ID
cat > /var/log/incidents/$INCIDENT_ID/incident.log <<EOF
故障ID: $INCIDENT_ID
开始时间: $(date)
严重程度: $SEVERITY
描述: $DESCRIPTION
处理人员: $(whoami)
EOF

# 2. 收集系统信息
echo "收集系统信息..."
systemctl status dd-3d-lottery > /var/log/incidents/$INCIDENT_ID/system_status.log
df -h > /var/log/incidents/$INCIDENT_ID/disk_usage.log
free -h > /var/log/incidents/$INCIDENT_ID/memory_usage.log
top -bn1 > /var/log/incidents/$INCIDENT_ID/cpu_usage.log

# 3. 检查合约状态
echo "检查合约状态..."
wasmd query wasm contract $CONTRACT_ADDRESS > /var/log/incidents/$INCIDENT_ID/contract_status.log

# 4. 发送告警通知
echo "发送告警通知..."
curl -X POST "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK" \
  -H "Content-Type: application/json" \
  -d "{
    \"text\": \"🚨 故障告警\",
    \"attachments\": [{
      \"color\": \"danger\",
      \"fields\": [
        {\"title\": \"故障ID\", \"value\": \"$INCIDENT_ID\", \"short\": true},
        {\"title\": \"严重程度\", \"value\": \"$SEVERITY\", \"short\": true},
        {\"title\": \"描述\", \"value\": \"$DESCRIPTION\", \"short\": false},
        {\"title\": \"时间\", \"value\": \"$(date)\", \"short\": true}
      ]
    }]
  }"

echo "故障响应完成！"
echo "故障记录保存在: /var/log/incidents/$INCIDENT_ID/"
```

### 3. 常见故障处理

#### 3.1 合约故障

```yaml
contract_faults:
  gas_limit_exceeded:
    symptoms: ["交易失败", "Gas不足错误"]
    causes: ["Gas限制设置过低", "合约逻辑复杂"]
    solutions: ["调整Gas限制", "优化合约逻辑"]
  
  storage_overflow:
    symptoms: ["存储写入失败", "数据丢失"]
    causes: ["存储空间不足", "数据量过大"]
    solutions: ["清理旧数据", "扩容存储"]
  
  permission_denied:
    symptoms: ["操作被拒绝", "权限错误"]
    causes: ["权限配置错误", "账户权限不足"]
    solutions: ["检查权限配置", "更新账户权限"]
```

#### 3.2 网络故障

```yaml
network_faults:
  rpc_timeout:
    symptoms: ["RPC调用超时", "网络连接失败"]
    causes: ["网络延迟", "RPC节点故障"]
    solutions: ["切换RPC节点", "增加超时时间"]
  
  chain_sync_issue:
    symptoms: ["链同步失败", "区块高度不一致"]
    causes: ["网络分区", "节点故障"]
    solutions: ["重启节点", "重新同步"]
```

## 📈 性能优化

### 1. 性能监控

#### 1.1 性能指标

```yaml
performance_metrics:
  response_time:
    target: "< 5秒"
    measurement: "平均响应时间"
    alert_threshold: "> 10秒"
  
  throughput:
    target: "100 TPS"
    measurement: "每秒交易数"
    alert_threshold: "< 50 TPS"
  
  gas_consumption:
    target: "< 100k"
    measurement: "平均Gas消耗"
    alert_threshold: "> 200k"
  
  error_rate:
    target: "< 1%"
    measurement: "错误率"
    alert_threshold: "> 5%"
```

#### 1.2 性能分析

```bash
#!/bin/bash
# performance_analysis.sh - 性能分析脚本

set -e

echo "开始性能分析..."

# 1. 收集性能数据
echo "收集性能数据..."
cargo bench > performance_benchmark.log

# 2. 分析Gas消耗
echo "分析Gas消耗..."
wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"get_stats": {}}' > gas_consumption.log

# 3. 分析响应时间
echo "分析响应时间..."
time wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"get_current_session": {}}' > response_time.log

# 4. 生成性能报告
echo "生成性能报告..."
cat > performance_report.md <<EOF
# 性能分析报告

## 基准测试结果
\`\`\`
$(cat performance_benchmark.log)
\`\`\`

## Gas消耗分析
\`\`\`
$(cat gas_consumption.log)
\`\`\`

## 响应时间分析
\`\`\`
$(cat response_time.log)
\`\`\`

## 优化建议
1. 优化存储操作
2. 减少不必要的计算
3. 使用批量操作
4. 优化数据结构
EOF

echo "性能分析完成！"
echo "报告保存在: performance_report.md"
```

### 2. 优化策略

#### 2.1 代码优化

```yaml
code_optimization:
  algorithm_optimization:
    - "使用更高效的排序算法"
    - "优化奖金分配算法"
    - "改进随机数生成算法"
    - "优化哈希计算"
  
  data_structure_optimization:
    - "使用更紧凑的数据结构"
    - "优化存储布局"
    - "减少内存分配"
    - "使用缓存机制"
  
  gas_optimization:
    - "减少存储操作"
    - "优化循环结构"
    - "使用批量操作"
    - "避免不必要的计算"
```

#### 2.2 系统优化

```yaml
system_optimization:
  hardware_optimization:
    - "使用SSD存储"
    - "增加内存容量"
    - "优化网络配置"
    - "使用专用硬件"
  
  software_optimization:
    - "优化Rust编译选项"
    - "使用性能分析工具"
    - "优化依赖库"
    - "使用并行处理"
  
  configuration_optimization:
    - "调整Gas限制"
    - "优化超时设置"
    - "配置缓存策略"
    - "调整并发参数"
```

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2024-01-XX | 初始部署与运维文档创建 | AI Assistant |

---

**注意**: 本文档提供了DD 3D彩票智能合约的完整部署与运维指南，应该根据实际环境进行调整和更新。
