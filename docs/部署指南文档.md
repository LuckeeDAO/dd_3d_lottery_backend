# DD 3D 彩票系统部署指南

## 🚀 部署概述

本指南将帮助您部署 DD 3D 彩票系统的前端和后端组件。

## 📋 部署前准备

### 环境要求

- Node.js 18+ (前端)
- Rust 1.70+ (后端)
- Docker (可选)
- Git

### 网络要求

- 区块链网络访问
- RPC 节点连接
- 部署权限

## 🏗️ 后端部署 (智能合约)

### 1. 准备环境

```bash
# 进入后端目录
cd backend

# 安装 Rust (如果未安装)
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 安装 CosmWasm 工具
cargo install cosmwasm-opt
```

### 2. 构建合约

```bash
# 构建合约
cargo build --release --target wasm32-unknown-unknown

# 优化 WASM 文件
cosmwasm-opt target/wasm32-unknown-unknown/release/dd_3d_lottery.wasm \
  -o target/wasm32-unknown-unknown/release/dd_3d_lottery_optimized.wasm
```

### 3. 部署合约

#### 方法 1：使用部署脚本

```bash
# 配置环境变量
export CHAIN_ID="cosmoshub-4"
export RPC_URL="https://rpc.cosmos.network"
export ADMIN_ADDRESS="cosmwasm1admin..."

# 运行部署脚本
./scripts/deploy.sh
```

#### 方法 2：手动部署

```bash
# 1. 上传合约代码
wasmd tx wasm store target/wasm32-unknown-unknown/release/dd_3d_lottery_optimized.wasm \
  --from <your-key> \
  --gas auto \
  --gas-adjustment 1.3 \
  --chain-id <chain-id> \
  --node <rpc-url> \
  --yes

# 2. 实例化合约
wasmd tx wasm instantiate <code-id> '{
  "admin": "<admin-address>",
  "service_fee_rate": "0.1",
  "min_bet_amount": "1000",
  "max_bet_amount": "1000000",
  "bet_denom": "uusd",
  "pause_requested": false
}' \
  --from <your-key> \
  --admin <admin-address> \
  --label "DD 3D Lottery" \
  --chain-id <chain-id> \
  --node <rpc-url> \
  --yes
```

### 4. 验证部署

```bash
# 查询合约信息
wasmd query wasm contract <contract-address>

# 查询合约配置
wasmd query wasm contract-state smart <contract-address> '{"get_config":{}}'
```

## 🌐 前端部署

### 1. 准备环境

```bash
# 进入前端目录
cd front

# 安装依赖
npm install
```

### 2. 配置环境变量

```bash
# 复制环境变量模板
cp env.example .env

# 编辑环境变量
nano .env
```

配置内容：
```env
VITE_CHAIN_ID=cosmoshub-4
VITE_RPC_URL=https://rpc.cosmos.network
VITE_CONTRACT_ADDRESS=cosmwasm1contract...
VITE_SENDER_ADDRESS=cosmwasm1sender...
```

### 3. 构建应用

```bash
# 构建生产版本
npm run build
```

### 4. 部署选项

#### 选项 1：Vercel 部署

```bash
# 安装 Vercel CLI
npm i -g vercel

# 登录 Vercel
vercel login

# 部署到 Vercel
vercel --prod
```

#### 选项 2：Docker 部署

```bash
# 构建 Docker 镜像
docker build -t dd-3d-lottery-frontend .

# 运行容器
docker run -p 3000:80 dd-3d-lottery-frontend
```

#### 选项 3：静态文件部署

```bash
# 构建完成后，将 dist 目录部署到任何静态文件服务器
# 例如：Nginx, Apache, CDN 等
```

## 🐳 Docker 部署

### 1. 后端 Docker 部署

```dockerfile
# backend/Dockerfile
FROM cosmwasm/workspace:0.16.0

WORKDIR /code
COPY . .

RUN cargo build --release --target wasm32-unknown-unknown

CMD ["cosmwasm-opt", "target/wasm32-unknown-unknown/release/dd_3d_lottery.wasm", "-o", "dd_3d_lottery_optimized.wasm"]
```

### 2. 前端 Docker 部署

```dockerfile
# front/Dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=0 /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### 3. Docker Compose 部署

```yaml
# docker-compose.yml
version: '3.8'

services:
  frontend:
    build: ./front
    ports:
      - "3000:80"
    environment:
      - VITE_CHAIN_ID=cosmoshub-4
      - VITE_RPC_URL=https://rpc.cosmos.network
      - VITE_CONTRACT_ADDRESS=cosmwasm1contract...
      - VITE_SENDER_ADDRESS=cosmwasm1sender...

  backend:
    build: ./backend
    environment:
      - CHAIN_ID=cosmoshub-4
      - RPC_URL=https://rpc.cosmos.network
```

## ☁️ 云平台部署

### 1. AWS 部署

```bash
# 使用 AWS CLI 部署
aws s3 sync dist/ s3://your-bucket-name
aws cloudfront create-invalidation --distribution-id YOUR_DISTRIBUTION_ID --paths "/*"
```

### 2. Google Cloud 部署

```bash
# 使用 gcloud CLI 部署
gcloud app deploy
```

### 3. Azure 部署

```bash
# 使用 Azure CLI 部署
az webapp deployment source config-zip --resource-group myResourceGroup --name myAppName --src dist.zip
```

## 🔧 环境配置

### 1. 开发环境

```bash
# 后端开发环境
cd backend
cargo run

# 前端开发环境
cd front
npm run dev
```

### 2. 测试环境

```bash
# 运行测试
cd backend && cargo test
cd front && npm run test
```

### 3. 生产环境

```bash
# 生产环境配置
export NODE_ENV=production
export RUST_LOG=info
```

## 📊 监控和日志

### 1. 应用监控

```bash
# 安装监控工具
npm install -g pm2

# 启动应用监控
pm2 start ecosystem.config.js
pm2 monit
```

### 2. 日志管理

```bash
# 查看日志
pm2 logs

# 日志轮转
pm2 install pm2-logrotate
```

### 3. 性能监控

```bash
# 安装性能监控
npm install -g clinic

# 性能分析
clinic doctor -- node app.js
```

## 🔒 安全配置

### 1. HTTPS 配置

```nginx
# nginx.conf
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    
    location / {
        root /usr/share/nginx/html;
        index index.html;
    }
}
```

### 2. 安全头部

```nginx
# 安全头部配置
add_header X-Frame-Options DENY;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
```

### 3. 访问控制

```bash
# 防火墙配置
ufw allow 22
ufw allow 80
ufw allow 443
ufw enable
```

## 🚨 故障排除

### 1. 常见问题

**问题：合约部署失败**
```bash
# 检查 Gas 设置
wasmd tx wasm store contract.wasm --gas auto --gas-adjustment 1.5
```

**问题：前端构建失败**
```bash
# 清理缓存
npm cache clean --force
rm -rf node_modules package-lock.json
npm install
```

**问题：Docker 构建失败**
```bash
# 清理 Docker 缓存
docker system prune -a
docker build --no-cache .
```

### 2. 日志分析

```bash
# 查看应用日志
pm2 logs

# 查看系统日志
journalctl -u your-service

# 查看 Docker 日志
docker logs container-name
```

### 3. 性能调优

```bash
# 前端性能分析
npm run build -- --analyze

# 后端性能分析
cargo build --release --target wasm32-unknown-unknown --verbose
```

## 📈 扩展部署

### 1. 负载均衡

```nginx
# nginx 负载均衡配置
upstream backend {
    server backend1:3000;
    server backend2:3000;
    server backend3:3000;
}

server {
    location /api {
        proxy_pass http://backend;
    }
}
```

### 2. 数据库部署

```bash
# PostgreSQL 部署
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=password \
  -e POSTGRES_DB=lottery \
  -p 5432:5432 \
  postgres:13
```

### 3. 缓存部署

```bash
# Redis 部署
docker run -d \
  --name redis \
  -p 6379:6379 \
  redis:6-alpine
```

## 📚 相关文档

- [系统架构设计](系统架构设计.md)
- [项目结构说明](项目结构说明.md)

## 🤝 支持

如果您在部署过程中遇到问题，请：

1. 查看 [故障排除](#故障排除) 部分
2. 搜索 [Issues](https://github.com/your-org/dd-3d-lottery/issues)
3. 创建新的 Issue

---

**DD 3D 彩票系统部署指南** - 完整的部署解决方案 🚀
